<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ShardingSphere | IT Forever Young</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="IT Forever Young">
    <link rel="preload" href="/assets/css/0.styles.b8e90e01.css" as="style"><link rel="preload" href="/assets/js/app.584c4a04.js" as="script"><link rel="preload" href="/assets/js/2.3b6f4584.js" as="script"><link rel="preload" href="/assets/js/19.18aa2616.js" as="script"><link rel="prefetch" href="/assets/js/10.6a3fda86.js"><link rel="prefetch" href="/assets/js/11.c13cfae9.js"><link rel="prefetch" href="/assets/js/12.4a8302da.js"><link rel="prefetch" href="/assets/js/13.45de68e6.js"><link rel="prefetch" href="/assets/js/14.bc50016c.js"><link rel="prefetch" href="/assets/js/15.14d47dda.js"><link rel="prefetch" href="/assets/js/16.e2e76922.js"><link rel="prefetch" href="/assets/js/17.2138e82f.js"><link rel="prefetch" href="/assets/js/18.0e0f42b4.js"><link rel="prefetch" href="/assets/js/20.b69fd60a.js"><link rel="prefetch" href="/assets/js/21.5175a320.js"><link rel="prefetch" href="/assets/js/22.021fcbdc.js"><link rel="prefetch" href="/assets/js/23.c352866c.js"><link rel="prefetch" href="/assets/js/24.236ea54e.js"><link rel="prefetch" href="/assets/js/25.7b6e3ebd.js"><link rel="prefetch" href="/assets/js/26.6fa28336.js"><link rel="prefetch" href="/assets/js/27.e81ad07d.js"><link rel="prefetch" href="/assets/js/28.2eecda04.js"><link rel="prefetch" href="/assets/js/29.3395de99.js"><link rel="prefetch" href="/assets/js/3.7bdb5164.js"><link rel="prefetch" href="/assets/js/30.f6dd6818.js"><link rel="prefetch" href="/assets/js/31.a5cdb8b8.js"><link rel="prefetch" href="/assets/js/32.e4220d48.js"><link rel="prefetch" href="/assets/js/33.fe9d7941.js"><link rel="prefetch" href="/assets/js/34.d207f938.js"><link rel="prefetch" href="/assets/js/35.f33b8b3c.js"><link rel="prefetch" href="/assets/js/36.894bee13.js"><link rel="prefetch" href="/assets/js/37.f11b99f4.js"><link rel="prefetch" href="/assets/js/38.56c2427a.js"><link rel="prefetch" href="/assets/js/39.8158b820.js"><link rel="prefetch" href="/assets/js/4.47cd2a72.js"><link rel="prefetch" href="/assets/js/40.1d618080.js"><link rel="prefetch" href="/assets/js/41.70d88f86.js"><link rel="prefetch" href="/assets/js/42.c20d87cf.js"><link rel="prefetch" href="/assets/js/43.763aaedd.js"><link rel="prefetch" href="/assets/js/44.2810b025.js"><link rel="prefetch" href="/assets/js/45.07473702.js"><link rel="prefetch" href="/assets/js/46.89647df9.js"><link rel="prefetch" href="/assets/js/47.6f7ecf2b.js"><link rel="prefetch" href="/assets/js/48.4dc7df62.js"><link rel="prefetch" href="/assets/js/49.557ffe1e.js"><link rel="prefetch" href="/assets/js/5.be996ab6.js"><link rel="prefetch" href="/assets/js/50.e5d85a8a.js"><link rel="prefetch" href="/assets/js/51.749d69bd.js"><link rel="prefetch" href="/assets/js/52.4788d0e1.js"><link rel="prefetch" href="/assets/js/53.c64d974b.js"><link rel="prefetch" href="/assets/js/54.e34a9fa6.js"><link rel="prefetch" href="/assets/js/55.43abf1e6.js"><link rel="prefetch" href="/assets/js/56.53468fef.js"><link rel="prefetch" href="/assets/js/57.9b3a8046.js"><link rel="prefetch" href="/assets/js/58.92452edc.js"><link rel="prefetch" href="/assets/js/59.0b13e960.js"><link rel="prefetch" href="/assets/js/6.7d3654d3.js"><link rel="prefetch" href="/assets/js/60.655097bf.js"><link rel="prefetch" href="/assets/js/61.a60e9416.js"><link rel="prefetch" href="/assets/js/62.b26f8b69.js"><link rel="prefetch" href="/assets/js/63.47aa7fd3.js"><link rel="prefetch" href="/assets/js/64.0096201e.js"><link rel="prefetch" href="/assets/js/65.8a7845b2.js"><link rel="prefetch" href="/assets/js/66.a054aa19.js"><link rel="prefetch" href="/assets/js/67.ac44c3bc.js"><link rel="prefetch" href="/assets/js/68.b509e9aa.js"><link rel="prefetch" href="/assets/js/69.0999c062.js"><link rel="prefetch" href="/assets/js/7.723fedf2.js"><link rel="prefetch" href="/assets/js/70.fd063402.js"><link rel="prefetch" href="/assets/js/71.f5d68c00.js"><link rel="prefetch" href="/assets/js/72.1b54346d.js"><link rel="prefetch" href="/assets/js/73.82a557c5.js"><link rel="prefetch" href="/assets/js/74.a081e008.js"><link rel="prefetch" href="/assets/js/75.5e47fde8.js"><link rel="prefetch" href="/assets/js/76.1ad651ae.js"><link rel="prefetch" href="/assets/js/77.e69e3503.js"><link rel="prefetch" href="/assets/js/78.ff3e8887.js"><link rel="prefetch" href="/assets/js/79.5a923f22.js"><link rel="prefetch" href="/assets/js/8.804819c1.js"><link rel="prefetch" href="/assets/js/80.0a2645b1.js"><link rel="prefetch" href="/assets/js/81.de26199b.js"><link rel="prefetch" href="/assets/js/9.a4c9ff74.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b8e90e01.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">IT Forever Young</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/interview/" class="nav-link">
  面试专题
</a></div> <a href="https://github.com/itForeverYoung/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/interview/" class="nav-link">
  面试专题
</a></div> <a href="https://github.com/itForeverYoung/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>数据库专题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/db/MySQL.html" class="sidebar-link">MySQL</a></li><li><a href="/db/MyCat.html" class="sidebar-link">Mycat</a></li><li><a href="/db/ShardingSphere.html" aria-current="page" class="active sidebar-link">ShardingSphere</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/db/ShardingSphere.html#数据分片" class="sidebar-link">数据分片</a></li><li class="sidebar-sub-header"><a href="/db/ShardingSphere.html#分片" class="sidebar-link">分片</a></li><li class="sidebar-sub-header"><a href="/db/ShardingSphere.html#配置" class="sidebar-link">配置</a></li><li class="sidebar-sub-header"><a href="/db/ShardingSphere.html#执行流程" class="sidebar-link">执行流程</a></li><li class="sidebar-sub-header"><a href="/db/ShardingSphere.html#分布式主键自增策略" class="sidebar-link">分布式主键自增策略</a></li><li class="sidebar-sub-header"><a href="/db/ShardingSphere.html#行表达式" class="sidebar-link">行表达式</a></li><li class="sidebar-sub-header"><a href="/db/ShardingSphere.html#主从分离" class="sidebar-link">主从分离</a></li><li class="sidebar-sub-header"><a href="/db/ShardingSphere.html#分页性能" class="sidebar-link">分页性能</a></li></ul></li><li><a href="/db/MongoDB.html" class="sidebar-link">MongoDB</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="shardingsphere"><a href="#shardingsphere" class="header-anchor">#</a> ShardingSphere</h1> <h2 id="数据分片"><a href="#数据分片" class="header-anchor">#</a> 数据分片</h2> <div class="language- extra-class"><pre><code>1. 逻辑表
2. 真实表
3. 数据节点
4. 绑定表（即mycat的childTable，父子表，按照同一个分片规则保存的主表和子表）
5. 广播表（即mycat的全局表）
6. 逻辑索引，某些数据库（如：PostgreSQL/Oracle）不允许同一个库存在名称相同索引，某些数据库（如：MySQL/SQLServer）则允许只要同一个表中不存在名称相同的索引即可。 逻辑索引用于同一个库不允许出现相同索引名称的分表场景，需要将同库不同表的索引名称改写为索引名 + 表名，改写之前的索引名称成为逻辑索引
</code></pre></div><h2 id="分片"><a href="#分片" class="header-anchor">#</a> 分片</h2> <div class="language- extra-class"><pre><code>1. 分片键，用于分片的字段
2. 分片算法，支持通过=、BETWEEN和IN分片。
	1. 精确分片算法：
	对应PreciseShardingAlgorithm，用于处理使用单一键作为分片键的=与IN进行分片的场景。需要配合StandardShardingStrategy使用。
	2. 范围分片算法：
	对应RangeShardingAlgorithm，用于处理使用单一键作为分片键的BETWEEN AND进行分片的场景。需要配合StandardShardingStrategy使用。
	3. 复合分片算法：
	对应ComplexKeysShardingAlgorithm，用于处理使用多键作为分片键进行分片的场景，包含多个分片键的逻辑较复杂，需要应用开发者自行处理其中的复杂度。需要配合ComplexShardingStrategy使用。
	4. Hint分片算法：
	对应HintShardingAlgorithm，用于处理使用Hint行分片的场景。需要配合HintShardingStrategy使用。
3. 分片策略
	1. 标准分片，提供对SQL语句中的=, IN和BETWEEN AND的分片操作支持。StandardShardingStrategy只支持单分片键。PreciseShardingAlgorithm是必选的，用于处理=和IN的分片。RangeShardingAlgorithm是可选的，用于处理BETWEEN AND分片。
	2. 复合分片，提供对SQL语句中的=, IN和BETWEEN AND的分片操作支持。ComplexShardingStrategy支持多分片键。
	3. 行表达式分片，提供对SQL语句中的=和IN的分片操作支持，只支持单分片键。
	4. Hint分片，对应HintShardingStrategy。通过Hint而非SQL解析的方式分片的策略。
	5. 不分片，对应NoneShardingStrategy。不分片的策略。
</code></pre></div><h2 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h2> <div class="language- extra-class"><pre><code>1. 自增主键生成策略，可以在客户端生成唯一主键。
2. 数据节点配置，配置逻辑表与真实表的映射关系。
	1. 均匀分布
	2. 自定义分布
</code></pre></div><h2 id="执行流程"><a href="#执行流程" class="header-anchor">#</a> 执行流程</h2> <h3 id="sql解析-执行器优化-sql路由-sql改写-sql执行-结果归并"><a href="#sql解析-执行器优化-sql路由-sql改写-sql执行-结果归并" class="header-anchor">#</a> SQL解析 =&gt; 执行器优化 =&gt; SQL路由 =&gt; SQL改写 =&gt; SQL执行 =&gt; 结果归并</h3> <div class="language- extra-class"><pre><code>1. 解析引擎
2. 路由引擎
	1. 分片路由，用于根据分片键进行路由的场景，又细分为直接路由、标准路由和笛卡尔积路由这3种类型。
	2. 广播路由，根据SQL类型又可以划分为全库路由、全库表路由、全实例路由、单播路由和阻断路由这5种类型。
3. 改写引擎
	1. 标识符改写，包括表名称、索引名称以及Schema名称，需要根据分片逻辑，找到对应逻辑表的真实表。
	2. 补列
		1. 第一种情况是ShardingSphere需要在结果归并时获取相应数据，但该数据并能未通过查询的SQL返回。 这种情况主要是针对GROUP BY和ORDER BY。结果归并时，需要根据GROUP BY和ORDER BY的字段项进行分组和排序，但如果原始SQL的选择项中若并未包含分组项或排序项，则需要对原始SQL进行改写。
		2. 第二种情况是使用AVG聚合函数。在分布式的场景中，使用avg1+avg2+avg3/3计算平均值并不正确，需要改写为 (sum1+sum2+sum3)/(count1+count2+count3)。这就需要将包含AVG的SQL改写为SUM和COUNT，并在结果归并时重新计算平均值。
		3. 第三种是在执行INSERT的SQL语句时，如果使用数据库自增主键，是无需写入主键字段的。但数据库的自增主键是无法满足分布式场景下的主键唯一的，因此ShardingSphere提供了分布式自增主键的生成策略，并且可以通过补列，让使用方无需改动现有代码，即可将分布式自增主键透明的替换数据库现有的自增主键。
	3. 分页修正
		1. 改写limit的SQL，类似于mycat的改写逻辑。
	4. 批量拆分
		1. 在使用批量插入的SQL时，如果插入的数据是跨分片的，那么需要对SQL进行改写来防止将多余的数据写入到数据库中。
	5. 优化改写
		1. 单节点优化，路由至单节点的SQL，则无需优化改写。
		2. 流式归并优化，它仅为包含GROUP BY的SQL增加ORDER BY以及和分组项相同的排序项和排序顺序，用于将内存归并转化为流式归并。
4. 执行引擎
	1. 目标是自动化的平衡资源控制与执行效率。
	2. 连接模式
		1. 内存限制模式（MEMORY_STRICTLY）
		2. 连接限制模式（CONNECTION_STRICTLY）
		3. 内存限制模式适用于OLAP操作，可以通过放宽对数据库连接的限制提升系统吞吐量；连接限制模式适用于OLTP操作，OLTP通常带有分片键，会路由到单一的分片，因此严格控制数据库连接，以保证在线系统数据库资源能够被更多的应用所使用
	3. 自动化执行引擎
		1. 配置maxConnectionSizePerQuery，该参数表示一次查询时每个数据库所允许使用的最大连接数。
		2. 为了避免获取数据库连接时造成死锁。
			1. 避免锁定一次性只需要获取1个数据库连接的操作。
			2. 仅针对内存限制模式时才进行资源锁定。
5. 归并引擎
	1. 从功能上分为遍历、排序、分组、分页和聚合5种类型。
	2. 从结构划分，可分为流式归并、内存归并和装饰者归并。流式归并和内存归并是互斥的，装饰者归并可以在流式归并和内存归并之上做进一步的处理。
	3. 遍历归并，遍历每个结果集，进行归并。
	4. 排序归并，在SQL语句有order by时，每个结果集都是有序的，采用流式归并的方式，每次都将当前游标指向的数据值进行排序，然后把第一个放入优先级队列，再将游标下移，以此方式将所有结果集进行排序。
	5. 分组归并，分为流式分组归并和内存分组归并。
		1. 流式分组归并要求SQL的排序项与分组项的字段以及排序类型（ASC或DESC）必须保持一致，否则只能通过内存归并才能保证其数据的正确性。
		2. 
		3. 当SQL中只包含分组语句时，根据不同数据库的实现，其排序的顺序不一定与分组顺序一致。 但由于排序语句的缺失，则表示此SQL并不在意排序顺序。 因此，ShardingSphere通过SQL优化的改写，自动增加与分组项一致的排序项，使其能够从消耗内存的内存分组归并方式转化为流式分组归并方案。
	6. 聚合归并
		1. 聚合函数可以归类为比较、累加和求平均值这3种类型。
	7. 分页归并
		1. 改写SQL语句，到每个分片上查询的limit，由limit offset,count修改成了limit 0,offset+count。然后，通过会优先通过流式归并获得结果集。
</code></pre></div><p>路由引擎：
<img src="https://shardingsphere.apache.org/document/legacy/3.x/document/img/sharding/route_architecture.png" alt="avatar"></p> <p>改写引擎：
<img src="https://shardingsphere.apache.org/document/legacy/3.x/document/img/sharding/rewrite_architecture_cn.png" alt="avatar"></p> <p>shardingSphere自动化执行引擎在准备阶段选择连接模式的计算方式：
<img src="https://shardingsphere.apache.org/document/legacy/3.x/document/img/sharding/connection_mode_cn.png" alt="avatar"></p> <p>自动化执行引擎：
<img src="https://shardingsphere.apache.org/document/legacy/3.x/document/img/sharding/execute_architecture_cn.png" alt="avatar"></p> <p>归并引擎：
<img src="https://shardingsphere.apache.org/document/legacy/3.x/document/img/sharding/merge_architecture_cn.png" alt="avatar"></p> <h2 id="分布式主键自增策略"><a href="#分布式主键自增策略" class="header-anchor">#</a> 分布式主键自增策略</h2> <div class="language- extra-class"><pre><code>1. 默认使用雪花算法，此算法能够保证不同进程主键的不重复性，以及相同进程主键的有序性。
2. 但它要求不同服务器之间要保证时间同步，否则可能会出现id重复（时间回拨）。
	1. 处理方式：默认分布式主键生成器提供了一个最大容忍的时钟回拨毫秒数。如果时钟回拨的时间超过最大容忍的毫秒数阈值，则程序报错；如果在可容忍的范围内，默认分布式主键生成器会等待时钟同步到最后一次主键生成的时间后再继续工作
3. 雪花算法生成的主键，二进制表示形式包含4部分，从高位到低位分表为：1bit符号位、41bit时间戳位、10bit工作进程位以及12bit序列号位。
	1. 1bit符号位恒为0。
</code></pre></div><h3 id="雪花算法"><a href="#雪花算法" class="header-anchor">#</a> 雪花算法</h3> <p><img src="https://shardingsphere.apache.org/document/legacy/3.x/document/img/sharding/snowflake_cn_v2.png" alt="avatar"></p> <h2 id="行表达式"><a href="#行表达式" class="header-anchor">#</a> 行表达式</h2> <div class="language- extra-class"><pre><code>1. 行表达式使用的是Groovy的语法。
</code></pre></div><h2 id="主从分离"><a href="#主从分离" class="header-anchor">#</a> 主从分离</h2> <div class="language- extra-class"><pre><code>1. 目前只支持一主多从。
2. 同一线程且同一数据库连接内，如有写入操作，以后的读操作均从主库读取，用于保证数据一致性。
</code></pre></div><h2 id="分页性能"><a href="#分页性能" class="header-anchor">#</a> 分页性能</h2> <div class="language- extra-class"><pre><code>1. 采用流式处理 + 归并排序的方式来避免内存的过量占用。
2. ShardingSphere对仅落至单分片的查询，不改写其SQL。
3. 优化思路：每次获取下一页时，都把上一页最后一条记录的id作为查询条件，可大幅度优化单个分片的查询速度和返回的结果集大小。
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/itForeverYoung/blog/edit/master/docs/db/ShardingSphere.md" target="_blank" rel="noopener noreferrer">在GitHub上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">5/18/2020, 4:36:12 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/db/MyCat.html" class="prev">
        Mycat
      </a></span> <span class="next"><a href="/db/MongoDB.html">
        MongoDB
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.584c4a04.js" defer></script><script src="/assets/js/2.3b6f4584.js" defer></script><script src="/assets/js/19.18aa2616.js" defer></script>
  </body>
</html>

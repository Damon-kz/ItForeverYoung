<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Java 中的排序算法 | 孤帆远影碧空尽</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="Hello World">
    
    <link rel="preload" href="/assets/css/0.styles.a3c91194.css" as="style"><link rel="preload" href="/assets/js/app.ecde336a.js" as="script"><link rel="preload" href="/assets/js/3.86996c84.js" as="script"><link rel="preload" href="/assets/js/1.31384522.js" as="script"><link rel="preload" href="/assets/js/85.5adee6bb.js" as="script"><link rel="prefetch" href="/assets/js/10.1db7b879.js"><link rel="prefetch" href="/assets/js/100.3554c2b4.js"><link rel="prefetch" href="/assets/js/101.55efd0c6.js"><link rel="prefetch" href="/assets/js/102.5d5960bf.js"><link rel="prefetch" href="/assets/js/103.9c9b3569.js"><link rel="prefetch" href="/assets/js/104.c77e9ac7.js"><link rel="prefetch" href="/assets/js/105.c17b62d1.js"><link rel="prefetch" href="/assets/js/106.59c930b6.js"><link rel="prefetch" href="/assets/js/107.087951d0.js"><link rel="prefetch" href="/assets/js/108.2ce3e63c.js"><link rel="prefetch" href="/assets/js/109.d32d9ad3.js"><link rel="prefetch" href="/assets/js/11.cefc73ed.js"><link rel="prefetch" href="/assets/js/110.f1de9abd.js"><link rel="prefetch" href="/assets/js/111.5039d966.js"><link rel="prefetch" href="/assets/js/112.0e3274bd.js"><link rel="prefetch" href="/assets/js/113.9e0c57a0.js"><link rel="prefetch" href="/assets/js/114.1eff609e.js"><link rel="prefetch" href="/assets/js/115.67c44a19.js"><link rel="prefetch" href="/assets/js/116.e198047e.js"><link rel="prefetch" href="/assets/js/117.5e5c3994.js"><link rel="prefetch" href="/assets/js/118.f053ba6e.js"><link rel="prefetch" href="/assets/js/119.f9513d38.js"><link rel="prefetch" href="/assets/js/12.93940570.js"><link rel="prefetch" href="/assets/js/120.87c5cca5.js"><link rel="prefetch" href="/assets/js/121.d76b6d5b.js"><link rel="prefetch" href="/assets/js/122.283e9572.js"><link rel="prefetch" href="/assets/js/123.d17719c8.js"><link rel="prefetch" href="/assets/js/124.f78cd2dc.js"><link rel="prefetch" href="/assets/js/125.c05fd363.js"><link rel="prefetch" href="/assets/js/126.c7371286.js"><link rel="prefetch" href="/assets/js/127.9fdf2512.js"><link rel="prefetch" href="/assets/js/128.4b64b7a2.js"><link rel="prefetch" href="/assets/js/129.565941b7.js"><link rel="prefetch" href="/assets/js/13.d3823667.js"><link rel="prefetch" href="/assets/js/130.09d3bc6a.js"><link rel="prefetch" href="/assets/js/131.be13eb7c.js"><link rel="prefetch" href="/assets/js/132.82a3150b.js"><link rel="prefetch" href="/assets/js/133.5818e2fe.js"><link rel="prefetch" href="/assets/js/14.78ff1c95.js"><link rel="prefetch" href="/assets/js/15.6f33849c.js"><link rel="prefetch" href="/assets/js/16.9d2cb895.js"><link rel="prefetch" href="/assets/js/17.e1e43e9b.js"><link rel="prefetch" href="/assets/js/18.02420d63.js"><link rel="prefetch" href="/assets/js/19.13be15ac.js"><link rel="prefetch" href="/assets/js/20.895e3823.js"><link rel="prefetch" href="/assets/js/21.4f5b6a40.js"><link rel="prefetch" href="/assets/js/22.a8cf410e.js"><link rel="prefetch" href="/assets/js/23.32fa556c.js"><link rel="prefetch" href="/assets/js/24.2225ff3a.js"><link rel="prefetch" href="/assets/js/25.90668033.js"><link rel="prefetch" href="/assets/js/26.d9e01966.js"><link rel="prefetch" href="/assets/js/27.93144dee.js"><link rel="prefetch" href="/assets/js/28.c3cedae4.js"><link rel="prefetch" href="/assets/js/29.578fab55.js"><link rel="prefetch" href="/assets/js/30.46d444ab.js"><link rel="prefetch" href="/assets/js/31.8aacee3a.js"><link rel="prefetch" href="/assets/js/32.5a0547c0.js"><link rel="prefetch" href="/assets/js/33.e47cc885.js"><link rel="prefetch" href="/assets/js/34.1496a79a.js"><link rel="prefetch" href="/assets/js/35.f2841d1c.js"><link rel="prefetch" href="/assets/js/36.2373c67d.js"><link rel="prefetch" href="/assets/js/37.d9db7f41.js"><link rel="prefetch" href="/assets/js/38.7716afd1.js"><link rel="prefetch" href="/assets/js/39.06c3f727.js"><link rel="prefetch" href="/assets/js/4.d2545411.js"><link rel="prefetch" href="/assets/js/40.3cdfc2d0.js"><link rel="prefetch" href="/assets/js/41.7cb8dc73.js"><link rel="prefetch" href="/assets/js/42.91c8afdb.js"><link rel="prefetch" href="/assets/js/43.47d51207.js"><link rel="prefetch" href="/assets/js/44.0b17e8ab.js"><link rel="prefetch" href="/assets/js/45.1574a31c.js"><link rel="prefetch" href="/assets/js/46.503c93e5.js"><link rel="prefetch" href="/assets/js/47.85d16cac.js"><link rel="prefetch" href="/assets/js/48.19b50820.js"><link rel="prefetch" href="/assets/js/49.eb8dfda1.js"><link rel="prefetch" href="/assets/js/5.3f111b5d.js"><link rel="prefetch" href="/assets/js/50.6b687ed4.js"><link rel="prefetch" href="/assets/js/51.75232a66.js"><link rel="prefetch" href="/assets/js/52.601cd2fb.js"><link rel="prefetch" href="/assets/js/53.23874dd0.js"><link rel="prefetch" href="/assets/js/54.4b8dd68e.js"><link rel="prefetch" href="/assets/js/55.245763db.js"><link rel="prefetch" href="/assets/js/56.10b42df9.js"><link rel="prefetch" href="/assets/js/57.e623b2eb.js"><link rel="prefetch" href="/assets/js/58.075f7fba.js"><link rel="prefetch" href="/assets/js/59.aba0413e.js"><link rel="prefetch" href="/assets/js/6.93473206.js"><link rel="prefetch" href="/assets/js/60.505a4ac3.js"><link rel="prefetch" href="/assets/js/61.90980b22.js"><link rel="prefetch" href="/assets/js/62.82b7f715.js"><link rel="prefetch" href="/assets/js/63.a6d73d0c.js"><link rel="prefetch" href="/assets/js/64.46de0709.js"><link rel="prefetch" href="/assets/js/65.530668a6.js"><link rel="prefetch" href="/assets/js/66.4a8b71e9.js"><link rel="prefetch" href="/assets/js/67.c030846a.js"><link rel="prefetch" href="/assets/js/68.4d3d8077.js"><link rel="prefetch" href="/assets/js/69.100e0a6b.js"><link rel="prefetch" href="/assets/js/7.ab8efa1d.js"><link rel="prefetch" href="/assets/js/70.4d8d651f.js"><link rel="prefetch" href="/assets/js/71.70d2eb17.js"><link rel="prefetch" href="/assets/js/72.6129679e.js"><link rel="prefetch" href="/assets/js/73.24290b7b.js"><link rel="prefetch" href="/assets/js/74.63f4acd1.js"><link rel="prefetch" href="/assets/js/75.7a320071.js"><link rel="prefetch" href="/assets/js/76.50a0a80f.js"><link rel="prefetch" href="/assets/js/77.1bc8199a.js"><link rel="prefetch" href="/assets/js/78.a4071825.js"><link rel="prefetch" href="/assets/js/79.b1948da2.js"><link rel="prefetch" href="/assets/js/8.e09fb395.js"><link rel="prefetch" href="/assets/js/80.8d07aaa9.js"><link rel="prefetch" href="/assets/js/81.c41f5586.js"><link rel="prefetch" href="/assets/js/82.bffcf2e0.js"><link rel="prefetch" href="/assets/js/83.49cdcb84.js"><link rel="prefetch" href="/assets/js/84.4b67351f.js"><link rel="prefetch" href="/assets/js/86.2110a8bc.js"><link rel="prefetch" href="/assets/js/87.5cc7d3f0.js"><link rel="prefetch" href="/assets/js/88.1a801c40.js"><link rel="prefetch" href="/assets/js/89.adc1a99f.js"><link rel="prefetch" href="/assets/js/9.b89d06ed.js"><link rel="prefetch" href="/assets/js/90.d9cdaff1.js"><link rel="prefetch" href="/assets/js/91.bbea32f0.js"><link rel="prefetch" href="/assets/js/92.69969fda.js"><link rel="prefetch" href="/assets/js/93.e4b90e1f.js"><link rel="prefetch" href="/assets/js/94.28e876b9.js"><link rel="prefetch" href="/assets/js/95.0085cfab.js"><link rel="prefetch" href="/assets/js/96.eff3005d.js"><link rel="prefetch" href="/assets/js/97.a949d34d.js"><link rel="prefetch" href="/assets/js/98.41acf2ce.js"><link rel="prefetch" href="/assets/js/99.2e5d68d3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a3c91194.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-2d5f533b><div data-v-2d5f533b><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-2d5f533b data-v-2d5f533b><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-64685f0e data-v-2d5f533b data-v-2d5f533b><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e>孤帆远影碧空尽</h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>鱼丸粗面</span>
            
          <span data-v-64685f0e>2019 - </span>
          2020
        </a></span></div></div> <div class="hide" data-v-2d5f533b><header class="navbar" data-v-2d5f533b><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">孤帆远影碧空尽</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/mysql/" class="nav-link"><i class="iconfont undefined"></i>
  mysql
</a></li><li class="dropdown-item"><!----> <a href="/categories/juc/" class="nav-link"><i class="iconfont undefined"></i>
  juc
</a></li><li class="dropdown-item"><!----> <a href="/categories/aqs/" class="nav-link"><i class="iconfont undefined"></i>
  aqs
</a></li><li class="dropdown-item"><!----> <a href="/categories/集合/" class="nav-link"><i class="iconfont undefined"></i>
  集合
</a></li><li class="dropdown-item"><!----> <a href="/categories/jvm/" class="nav-link"><i class="iconfont undefined"></i>
  jvm
</a></li><li class="dropdown-item"><!----> <a href="/categories/mq/" class="nav-link"><i class="iconfont undefined"></i>
  mq
</a></li><li class="dropdown-item"><!----> <a href="/categories/spring/" class="nav-link"><i class="iconfont undefined"></i>
  spring
</a></li><li class="dropdown-item"><!----> <a href="/categories/spring boot/" class="nav-link"><i class="iconfont undefined"></i>
  spring boot
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      Java
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/jvm/" class="nav-link"><i class="iconfont undefined"></i>
  Jvm
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      开源框架
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link"><i class="iconfont undefined"></i>
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/dubbo/" class="nav-link"><i class="iconfont undefined"></i>
  Dubbo
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      数据库
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/db/mysql/" class="nav-link"><i class="iconfont undefined"></i>
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/redis/" class="nav-link"><i class="iconfont undefined"></i>
  Redis
</a></li></ul></div></div><div class="nav-item"><a href="/mq/" class="nav-link"><i class="iconfont undefined"></i>
  消息中间件
</a></div> <a href="https://github.com/itForeverYoung/blog" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask" data-v-2d5f533b></div> <aside class="sidebar" data-v-2d5f533b><div class="personal-info-wrapper" data-v-ca798c94 data-v-2d5f533b><img src="logo.png" alt="author-avatar" class="personal-img" data-v-ca798c94> <h3 class="name" data-v-ca798c94>
    鱼丸粗面
  </h3> <div class="num" data-v-ca798c94><div data-v-ca798c94><h3 data-v-ca798c94>10</h3> <h6 data-v-ca798c94>文章</h6></div> <div data-v-ca798c94><h3 data-v-ca798c94>20</h3> <h6 data-v-ca798c94>标签</h6></div></div> <hr data-v-ca798c94></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/mysql/" class="nav-link"><i class="iconfont undefined"></i>
  mysql
</a></li><li class="dropdown-item"><!----> <a href="/categories/juc/" class="nav-link"><i class="iconfont undefined"></i>
  juc
</a></li><li class="dropdown-item"><!----> <a href="/categories/aqs/" class="nav-link"><i class="iconfont undefined"></i>
  aqs
</a></li><li class="dropdown-item"><!----> <a href="/categories/集合/" class="nav-link"><i class="iconfont undefined"></i>
  集合
</a></li><li class="dropdown-item"><!----> <a href="/categories/jvm/" class="nav-link"><i class="iconfont undefined"></i>
  jvm
</a></li><li class="dropdown-item"><!----> <a href="/categories/mq/" class="nav-link"><i class="iconfont undefined"></i>
  mq
</a></li><li class="dropdown-item"><!----> <a href="/categories/spring/" class="nav-link"><i class="iconfont undefined"></i>
  spring
</a></li><li class="dropdown-item"><!----> <a href="/categories/spring boot/" class="nav-link"><i class="iconfont undefined"></i>
  spring boot
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      Java
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link router-link-active"><i class="iconfont undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/jvm/" class="nav-link"><i class="iconfont undefined"></i>
  Jvm
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      开源框架
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/" class="nav-link"><i class="iconfont undefined"></i>
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/dubbo/" class="nav-link"><i class="iconfont undefined"></i>
  Dubbo
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      数据库
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/db/mysql/" class="nav-link"><i class="iconfont undefined"></i>
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/redis/" class="nav-link"><i class="iconfont undefined"></i>
  Redis
</a></li></ul></div></div><div class="nav-item"><a href="/mq/" class="nav-link"><i class="iconfont undefined"></i>
  消息中间件
</a></div> <a href="https://github.com/itForeverYoung/blog" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Java专题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/aqs.html" class="sidebar-link">AQS 源码分析</a></li><li><a href="/java/ReentrantLock.html" class="sidebar-link">ReentrantLock 源码分析</a></li><li><a href="/java/ReentrantReadWriteLock.html" class="sidebar-link">ReentrantReadWriteLock 源码分析</a></li><li><a href="/java/CountDownLatch.html" class="sidebar-link">CountDownLatch 源码分析</a></li><li><a href="/java/CyclicBarrier.html" class="sidebar-link">CyclicBarrier 源码分析</a></li><li><a href="/java/Semaphore.html" class="sidebar-link">Semaphore 源码分析</a></li><li><a href="/java/thread-pool-executor.html" class="sidebar-link">ThreadPoolExecutor 线程池</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-64685f0e data-v-2d5f533b><h3 class="title" style="display:none;" data-v-64685f0e data-v-64685f0e></h3> <!----> <label id="box" class="inputBox" style="display:none;" data-v-64685f0e data-v-64685f0e><input type="password" value="" data-v-64685f0e> <span data-v-64685f0e>Konck! Knock!</span> <button data-v-64685f0e>OK</button></label> <div class="footer" style="display:none;" data-v-64685f0e data-v-64685f0e><span data-v-64685f0e><i class="iconfont reco-theme" data-v-64685f0e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-64685f0e>vuePress-theme-reco</a></span> <span data-v-64685f0e><i class="iconfont reco-copyright" data-v-64685f0e></i> <a data-v-64685f0e><span data-v-64685f0e>鱼丸粗面</span>
            
          <span data-v-64685f0e>2019 - </span>
          2020
        </a></span></div></div> <div data-v-2d5f533b><main class="page" style="padding-right:0;"><div class="page-title" style="display:none;"><h1 class="title">Java 中的排序算法</h1> <div data-v-3b7f5bdf><i class="iconfont reco-account" data-v-3b7f5bdf><span data-v-3b7f5bdf>鱼丸粗面</span></i> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default" style="display:none;"><h1 id="java-中的排序算法"><a href="#java-中的排序算法" class="header-anchor">#</a> Java 中的排序算法</h1> <h2 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h2> <ol><li>了解哪些排序算法？</li> <li>快排的实现原理知道吗？时间复杂度是多少？</li> <li>Java中的排序算法有了解过吗？</li> <li>Collections#sort()和Arrays.sort()的实现有什么区别？</li></ol> <h2 id="源码分析"><a href="#源码分析" class="header-anchor">#</a> 源码分析</h2> <h3 id="简要分析"><a href="#简要分析" class="header-anchor">#</a> 简要分析</h3> <p>首先了解一点，<code>Collections#sort()</code>方法，实际上是在其内部调用了<code>List#sort()</code>，而<code>List#sort()</code>方法内部又调用了<code>Arrays#sort()</code>方法，所以实际上，<code>Collections#sort()</code>就是<code>Arrays.sort()</code>。</p> <p>那么，看下表，表中列举了在<code>Arrays</code>类中实现、调用的4种排序算法。</p> <table><thead><tr><th>排序算法</th> <th>实现类</th> <th>调用方法</th> <th>状态</th></tr></thead> <tbody><tr><td><code>TimSort</code></td> <td><code>TimSort#sort()</code></td> <td>引用类型的<code>Arrays.sort()</code></td> <td>正常，默认使用</td></tr> <tr><td><code>ComparableTimSort</code></td> <td><code>ComparableTimSort#sort()</code></td> <td>引用类型的<code>Arrays.parallelSort()</code></td> <td>正常，默认使用</td></tr> <tr><td>双轴快排</td> <td><code>DualPivotQuicksort#sort()</code></td> <td>基本类型的<code>Arrays.sort()</code></td> <td>正常，默认使用</td></tr> <tr><td>原始归并排序</td> <td><code>Arrays#legacyMergeSort()</code></td> <td>引用类型的<code>Arrays.sort()</code></td> <td>在未来版本可能会被移除</td></tr></tbody></table> <p>从上面的表格可以看出，Arrays类中，最主要调用的两种排序算法实现，就是TimSort和双轴快排。</p> <p>所以下文呢，就主要分析这两种实现。</p> <h3 id="arrays"><a href="#arrays" class="header-anchor">#</a> Arrays</h3> <p>首先，<code>Arrays</code>类中定义了两个阈值常量。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 不启用并行排序的数组长度的最大值，意思就是说，如果数组长度超过了这个值，那就要使用并行排序了，主要是在parallelSort方法中使用</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MIN_ARRAY_SORT_GRAN <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">13</span><span class="token punctuation">;</span>
<span class="token comment">// 使用插入排序的阈值，如果数组长度小于这个阈值，那就使用插入排序，主要是在mergeSort方法中使用</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> INSERTIONSORT_THRESHOLD <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
</code></pre></div><p>下面就是重头戏了！</p> <h3 id="timsort-sort"><a href="#timsort-sort" class="header-anchor">#</a> TimSort#sort</h3> <p>首先，了解下，什么是<code>TimSort</code>算法；</p> <ol><li></li></ol> <p>然后，再看下<code>TimSort</code>和<code>ComparableTimSort</code>区别；</p> <table><thead><tr><th>实现类</th> <th>区别</th></tr></thead> <tbody><tr><td><code>TimSort#sort()</code></td> <td>使用自定义的<code>Comparator</code>比较器比较大小</td></tr> <tr><td><code>ComparableTimSort#sort()</code></td> <td>使用实现了<code>Comparable</code>接口的类的<code>compareTo</code>方法比较大小</td></tr></tbody></table> <p>最后，以<code>TimSort</code>类为例，来分析Java中是如何实现<code>TimSort</code>算法的。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 定义了一组默认的常量值</span>
<span class="token comment">// 可以进行归并操作的数组的最小长度</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MIN_MERGE <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>
<span class="token comment">// </span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span>  MIN_GALLOP <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
<span class="token comment">// </span>
<span class="token keyword">private</span> <span class="token keyword">int</span> minGallop <span class="token operator">=</span> MIN_GALLOP<span class="token punctuation">;</span>
<span class="token comment">// 默认初始化的临时数组的长度</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> INITIAL_TMP_STORAGE_LENGTH <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>

<span class="token comment">// 实例属性</span>
<span class="token comment">// 记录了栈深度</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> stackSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// Number of pending runs on stack</span>
<span class="token comment">// 记录了每个run的起始位置</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> runBase<span class="token punctuation">;</span>
<span class="token comment">// 记录了每个run的长度</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> runLen<span class="token punctuation">;</span>
<span class="token comment">/**
 * 构造方法
 */</span>
<span class="token keyword">private</span> <span class="token class-name">TimSort</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> work<span class="token punctuation">,</span> <span class="token keyword">int</span> workBase<span class="token punctuation">,</span> <span class="token keyword">int</span> workLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 给待比较数组赋值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> a<span class="token punctuation">;</span>
    <span class="token comment">// 给比较器赋值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>c <span class="token operator">=</span> c<span class="token punctuation">;</span>
    <span class="token comment">// Allocate temp storage (which may be increased later if necessary)</span>
    <span class="token comment">// 数组长度</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> a<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">// 计算临时数组长度</span>
    <span class="token keyword">int</span> tlen <span class="token operator">=</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">*</span> INITIAL_TMP_STORAGE_LENGTH<span class="token punctuation">)</span> <span class="token operator">?</span>
        len <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span> <span class="token operator">:</span> INITIAL_TMP_STORAGE_LENGTH<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>work <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> workLen <span class="token operator">&lt;</span> tlen <span class="token operator">||</span> workBase <span class="token operator">+</span> tlen <span class="token operator">&gt;</span> work<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;UnnecessaryLocalVariable&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newArray <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span><span class="token class-name">Array</span><span class="token punctuation">.</span>newInstance
            <span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getComponentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tmp <span class="token operator">=</span> newArray<span class="token punctuation">;</span>
        tmpBase <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        tmpLen <span class="token operator">=</span> tlen<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        tmp <span class="token operator">=</span> work<span class="token punctuation">;</span>
        tmpBase <span class="token operator">=</span> workBase<span class="token punctuation">;</span>
        tmpLen <span class="token operator">=</span> workLen<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
     * Allocate runs-to-be-merged stack (which cannot be expanded).  The
     * stack length requirements are described in listsort.txt.  The C
     * version always uses the same stack length (85), but this was
     * measured to be too expensive when sorting &quot;mid-sized&quot; arrays (e.g.,
     * 100 elements) in Java.  Therefore, we use smaller (but sufficiently
     * large) stack lengths for smaller arrays.  The &quot;magic numbers&quot; in the
     * computation below must be changed if MIN_MERGE is decreased.  See
     * the MIN_MERGE declaration above for more information.
     * The maximum value of 49 allows for an array up to length
     * Integer.MAX_VALUE-4, if array is filled by the worst case stack size
     * increasing scenario. More explanations are given in section 4 of:
     * http://envisage-project.eu/wp-content/uploads/2015/02/sorting.pdf
     */</span>
    <span class="token comment">// 计算栈的深度，也就是runBase和runLen两个数组的大小</span>
    <span class="token comment">// 栈深度取值在5、10、24、49之间</span>
    <span class="token keyword">int</span> stackLen <span class="token operator">=</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span>    <span class="token number">120</span>  <span class="token operator">?</span>  <span class="token number">5</span> <span class="token operator">:</span>
                    len <span class="token operator">&lt;</span>   <span class="token number">1542</span>  <span class="token operator">?</span> <span class="token number">10</span> <span class="token operator">:</span>
                    len <span class="token operator">&lt;</span> <span class="token number">119151</span>  <span class="token operator">?</span> <span class="token number">24</span> <span class="token operator">:</span> <span class="token number">49</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    runBase <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>stackLen<span class="token punctuation">]</span><span class="token punctuation">;</span>
    runLen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>stackLen<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> lo<span class="token punctuation">,</span> <span class="token keyword">int</span> hi<span class="token punctuation">,</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">,</span>
                        <span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> work<span class="token punctuation">,</span> <span class="token keyword">int</span> workBase<span class="token punctuation">,</span> <span class="token keyword">int</span> workLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 校验参数的正确性</span>
    <span class="token keyword">assert</span> c <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> a <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> lo <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> lo <span class="token operator">&lt;=</span> hi <span class="token operator">&amp;&amp;</span> hi <span class="token operator">&lt;=</span> a<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">// 计算当前要排序的元素个数</span>
    <span class="token keyword">int</span> nRemaining  <span class="token operator">=</span> hi <span class="token operator">-</span> lo<span class="token punctuation">;</span>
    <span class="token comment">// 如果小于2，就说明只有1个或0个元素待排序，那就直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nRemaining <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>  <span class="token comment">// Arrays of size 0 and 1 are always sorted</span>
    <span class="token comment">// 如果待排序数组元素大于2，小于MIN_MERGE（），说明现在待排序的元素比较少，那就使用二分插入排序</span>
    <span class="token comment">// If array is small, do a &quot;mini-TimSort&quot; with no merges</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nRemaining <span class="token operator">&lt;</span> MIN_MERGE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 找到从lo开始的第一个升序区间run</span>
        <span class="token keyword">int</span> initRunLen <span class="token operator">=</span> <span class="token function">countRunAndMakeAscending</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> lo<span class="token punctuation">,</span> hi<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用二分插入排序</span>
        <span class="token function">binarySort</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> lo<span class="token punctuation">,</span> hi<span class="token punctuation">,</span> lo <span class="token operator">+</span> initRunLen<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * March over the array once, left to right, finding natural runs,
     * extending short natural runs to minRun elements, and merging runs
     * to maintain stack invariant.
     */</span>
    <span class="token comment">//  初始化一个TimSort实例</span>
    <span class="token class-name">TimSort</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> ts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimSort</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> c<span class="token punctuation">,</span> work<span class="token punctuation">,</span> workBase<span class="token punctuation">,</span> workLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
     * 根据待排序数组长度，计算可以进行归并排序的run的最小长度
     * 1. 如果nRemaining &lt; MIN_MERGE(32)，minRun = nRemaining
     * 2. 如果nRemaining是2的幂次方，minRun = 16
     * 3. 否则，minRun就是一个介于16 - 32之间的一个整数
     */</span>
    <span class="token keyword">int</span> minRun <span class="token operator">=</span> <span class="token function">minRunLength</span><span class="token punctuation">(</span>nRemaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 下面是一个do while循环，当nRemaining==0时，循环结束</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// Identify next run</span>
        <span class="token comment">// 确认下一个run的长度</span>
        <span class="token keyword">int</span> runLen <span class="token operator">=</span> <span class="token function">countRunAndMakeAscending</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> lo<span class="token punctuation">,</span> hi<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// If run is short, extend to min(minRun, nRemaining)</span>
        <span class="token comment">// 如果当前这个run长度小于minRun，那就进行二分插入排序</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>runLen <span class="token operator">&lt;</span> minRun<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> force <span class="token operator">=</span> nRemaining <span class="token operator">&lt;=</span> minRun <span class="token operator">?</span> nRemaining <span class="token operator">:</span> minRun<span class="token punctuation">;</span>
            <span class="token function">binarySort</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> lo<span class="token punctuation">,</span> lo <span class="token operator">+</span> force<span class="token punctuation">,</span> lo <span class="token operator">+</span> runLen<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            runLen <span class="token operator">=</span> force<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 将当前run推到栈顶，其实就是把lo设置到runBase中，把runLen添加到runLen中，通过stackSize属性记录栈的深度</span>
        <span class="token comment">// Push run onto pending-run stack, and maybe merge</span>
        ts<span class="token punctuation">.</span><span class="token function">pushRun</span><span class="token punctuation">(</span>lo<span class="token punctuation">,</span> runLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 然后调用mergeCollapse()方法，mergeCollapse方法中会判断是否要对栈顶的几个run进行merge</span>
        ts<span class="token punctuation">.</span><span class="token function">mergeCollapse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
        <span class="token comment">// Advance to find next run</span>
        <span class="token comment">// 将lo移动runLen长度</span>
        lo <span class="token operator">+=</span> runLen<span class="token punctuation">;</span>
        <span class="token comment">// 将待排序长度-runLen</span>
        nRemaining <span class="token operator">-=</span> runLen<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>nRemaining <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Merge all remaining runs to complete sort</span>
    <span class="token comment">// check，循环结束后，lo一定等于hi</span>
    <span class="token keyword">assert</span> lo <span class="token operator">==</span> hi<span class="token punctuation">;</span>
    <span class="token comment">// 进行最终的merge操作</span>
    ts<span class="token punctuation">.</span><span class="token function">mergeForceCollapse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 最终merge完之后，栈顶只会剩下一个run，也就是已经排好序的数组</span>
    <span class="token keyword">assert</span> ts<span class="token punctuation">.</span>stackSize <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 找到一个严格升序的区间，称为一个run
 * 1. 找出严格升序的最大个数
 * 2. 找出严格降序的最大个数，并将其反转成升序
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">int</span> <span class="token function">countRunAndMakeAscending</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> lo<span class="token punctuation">,</span> <span class="token keyword">int</span> hi<span class="token punctuation">,</span>
                                                <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 校验，lo必须小于hi</span>
    <span class="token keyword">assert</span> lo <span class="token operator">&lt;</span> hi<span class="token punctuation">;</span>
    <span class="token comment">// 如果lo+1=hi，说明只有两个元素，返回1即可</span>
    <span class="token keyword">int</span> runHi <span class="token operator">=</span> lo <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>runHi <span class="token operator">==</span> hi<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果a[lo+1] &lt; a[lo]，说明接下来应该是严格降序</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>runHi<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span>lo<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Descending</span>
        <span class="token comment">// 那就从当前位置，一直向后遍历，直到严格降序结束</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>runHi <span class="token operator">&lt;</span> hi <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>runHi<span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span>runHi <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            runHi<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token comment">// 将(lo -&gt; runHi)这个严格降序的区间内的元素反转成升序</span>
        <span class="token function">reverseRange</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> lo<span class="token punctuation">,</span> runHi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                              <span class="token comment">// Ascending</span>
        <span class="token comment">// 进入else，说明接下来应该是严格升序，一直向后遍历，直到严格升序结束</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>runHi <span class="token operator">&lt;</span> hi <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>runHi<span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span>runHi <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            runHi<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 最后，返回runHi-lo。</span>
    <span class="token comment">// 说明，从lo开始向后遍历(runHi-lo)个元素，是升序的</span>
    <span class="token keyword">return</span> runHi <span class="token operator">-</span> lo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 将区间[lo, hi]之间的元素由降序反转成升序
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">reverseRange</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> lo<span class="token punctuation">,</span> <span class="token keyword">int</span> hi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    hi<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>lo <span class="token operator">&lt;</span> hi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> t <span class="token operator">=</span> a<span class="token punctuation">[</span>lo<span class="token punctuation">]</span><span class="token punctuation">;</span>
        a<span class="token punctuation">[</span>lo<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>hi<span class="token punctuation">]</span><span class="token punctuation">;</span>
        a<span class="token punctuation">[</span>hi<span class="token operator">--</span><span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 二分插入排序算法实现
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">binarySort</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> lo<span class="token punctuation">,</span> <span class="token keyword">int</span> hi<span class="token punctuation">,</span> <span class="token keyword">int</span> start<span class="token punctuation">,</span>
                                    <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 校验参数</span>
    <span class="token keyword">assert</span> lo <span class="token operator">&lt;=</span> start <span class="token operator">&amp;&amp;</span> start <span class="token operator">&lt;=</span> hi<span class="token punctuation">;</span>
    <span class="token comment">// 如果start=lo，那就把start++，即从下一个元素开始比较</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> lo<span class="token punctuation">)</span>
        start<span class="token operator">++</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 下面就是二分插入排序算法的主要实现</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> start <span class="token operator">&lt;</span> hi<span class="token punctuation">;</span> start<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 得到当前元素</span>
        <span class="token class-name">T</span> pivot <span class="token operator">=</span> a<span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// Set left (and right) to the index where a[start] (pivot) belongs</span>
        <span class="token comment">// left永远是lo，而[left, start-1]是已经有序的区间</span>
        <span class="token keyword">int</span> left <span class="token operator">=</span> lo<span class="token punctuation">;</span>
        <span class="token comment">/*
         * 这里把right定义成start，也就是说，把已经有序的数组长度+1，
         * 然后将a[start]和[left, start-1]区间中的元素进行比较，移位，从而得到一个有序的[left, start]区间，
         * 而二分插入排序，就是把比较操作优化了一下，通过二分查找，找到a[start]应该插入的位置a[x]，然后将[x, start-1]区间的元素向后移动一个位置，得到[x+1, start]。
         */</span>
        <span class="token keyword">int</span> right <span class="token operator">=</span> start<span class="token punctuation">;</span>
        <span class="token comment">// check</span>
        <span class="token keyword">assert</span> left <span class="token operator">&lt;=</span> right<span class="token punctuation">;</span>
        
        <span class="token comment">/*
         * 循环结束后，一定能得到下标left，能满足，
         * 1. pivot &gt;= all in [lo, left),
         * 2. pivot &lt;  all in [right, start).
         */</span> 
        <span class="token comment">// 这个while循环就是二分查找，找到pivot需要插入的位置，</span>
        <span class="token comment">// 当left==right时循环结束，所以此时，a[left]就是pivot需要插入的位置</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> mid <span class="token operator">=</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> right<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment">/*
             * ComparableTimSort和TimSort的实现区别就在这个地方，
             * 1. ComparableTimSort比较的是实现了Comparable接口的类，调用的是java.lang.Comparable#compareTo方法
             * 2. TimSort是通过传入的Comparator比较器进行比较的，调用的是java.util.Comparator#compare方法
             */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>pivot<span class="token punctuation">,</span> a<span class="token punctuation">[</span>mid<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                right <span class="token operator">=</span> mid<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                left <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">assert</span> left <span class="token operator">==</span> right<span class="token punctuation">;</span>

        <span class="token comment">/*
         * The invariants still hold: pivot &gt;= all in [lo, left) and
         * pivot &lt; all in [left, start), so pivot belongs at left.  Note
         * that if there are elements equal to pivot, left points to the
         * first slot after them -- that's why this sort is stable.
         * Slide elements over to make room for pivot.
         */</span>
        <span class="token comment">// 计算需要移动的元素个数</span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> start <span class="token operator">-</span> left<span class="token punctuation">;</span>  <span class="token comment">// The number of elements to move</span>
        <span class="token comment">// Switch is just an optimization for arraycopy in default case</span>
        <span class="token comment">// 如果只需要移动一、两个元素，直接手动copy下；如果n &gt; 2，就调用系统的arraycopy方法</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>  a<span class="token punctuation">[</span>left <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>left <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>  a<span class="token punctuation">[</span>left <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> left<span class="token punctuation">,</span> a<span class="token punctuation">,</span> left <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 这里将pivot赋值给a[left]</span>
        a<span class="token punctuation">[</span>left<span class="token punctuation">]</span> <span class="token operator">=</span> pivot<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 根据传入的长度n，计算可以进行归并排序的run的最小长度
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">minRunLength</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span> n <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token comment">// Becomes 1 if any 1 bits are shifted off</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;=</span> MIN_MERGE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        r <span class="token operator">|=</span> <span class="token punctuation">(</span>n <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        n <span class="token operator">&gt;&gt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> n <span class="token operator">+</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 将当前run推到栈顶
 * runBase：当前run的起始下标
 * runLen：当前run的长度
 * stackSize：栈的深度
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">pushRun</span><span class="token punctuation">(</span><span class="token keyword">int</span> runBase<span class="token punctuation">,</span> <span class="token keyword">int</span> runLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>runBase<span class="token punctuation">[</span>stackSize<span class="token punctuation">]</span> <span class="token operator">=</span> runBase<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>runLen<span class="token punctuation">[</span>stackSize<span class="token punctuation">]</span> <span class="token operator">=</span> runLen<span class="token punctuation">;</span>
    stackSize<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 合并run
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">mergeCollapse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>stackSize <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> stackSize <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> runLen<span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> runLen<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">+</span> runLen<span class="token punctuation">[</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>runLen<span class="token punctuation">[</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> runLen<span class="token punctuation">[</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                n<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token function">mergeAt</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>runLen<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> runLen<span class="token punctuation">[</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">mergeAt</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// Invariant is established</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">mergeForceCollapse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>stackSize <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> stackSize <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> runLen<span class="token punctuation">[</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> runLen<span class="token punctuation">[</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            n<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token function">mergeAt</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">mergeAt</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span> stackSize <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span> i <span class="token operator">==</span> stackSize <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">||</span> i <span class="token operator">==</span> stackSize <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> base1 <span class="token operator">=</span> runBase<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> len1 <span class="token operator">=</span> runLen<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> base2 <span class="token operator">=</span> runBase<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> len2 <span class="token operator">=</span> runLen<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span> len1 <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> len2 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span> base1 <span class="token operator">+</span> len1 <span class="token operator">==</span> base2<span class="token punctuation">;</span>

    <span class="token comment">/*
     * Record the length of the combined runs; if i is the 3rd-last
     * run now, also slide over the last run (which isn't involved
     * in this merge).  The current run (i+1) goes away in any case.
     */</span>
    runLen<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> len1 <span class="token operator">+</span> len2<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> stackSize <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        runBase<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> runBase<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        runLen<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> runLen<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    stackSize<span class="token operator">--</span><span class="token punctuation">;</span>

    <span class="token comment">/*
     * Find where the first element of run2 goes in run1. Prior elements
     * in run1 can be ignored (because they're already in place).
     */</span>
    <span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token function">gallopRight</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>base2<span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> base1<span class="token punctuation">,</span> len1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span> k <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    base1 <span class="token operator">+=</span> k<span class="token punctuation">;</span>
    len1 <span class="token operator">-=</span> k<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">/*
     * Find where the last element of run1 goes in run2. Subsequent elements
     * in run2 can be ignored (because they're already in place).
     */</span>
    len2 <span class="token operator">=</span> <span class="token function">gallopLeft</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>base1 <span class="token operator">+</span> len1 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> base2<span class="token punctuation">,</span> len2<span class="token punctuation">,</span> len2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span> len2 <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// Merge remaining runs, using tmp array with min(len1, len2) elements</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len1 <span class="token operator">&lt;=</span> len2<span class="token punctuation">)</span>
        <span class="token function">mergeLo</span><span class="token punctuation">(</span>base1<span class="token punctuation">,</span> len1<span class="token punctuation">,</span> base2<span class="token punctuation">,</span> len2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">mergeHi</span><span class="token punctuation">(</span>base1<span class="token punctuation">,</span> len1<span class="token punctuation">,</span> base2<span class="token punctuation">,</span> len2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">int</span> <span class="token function">gallopLeft</span><span class="token punctuation">(</span><span class="token class-name">T</span> key<span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> base<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">int</span> hint<span class="token punctuation">,</span>
                                    <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span> len <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> hint <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> hint <span class="token operator">&lt;</span> len<span class="token punctuation">;</span>
    <span class="token keyword">int</span> lastOfs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ofs <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> a<span class="token punctuation">[</span>base <span class="token operator">+</span> hint<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Gallop right until a[base+hint+lastOfs] &lt; key &lt;= a[base+hint+ofs]</span>
        <span class="token keyword">int</span> maxOfs <span class="token operator">=</span> len <span class="token operator">-</span> hint<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>ofs <span class="token operator">&lt;</span> maxOfs <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> a<span class="token punctuation">[</span>base <span class="token operator">+</span> hint <span class="token operator">+</span> ofs<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lastOfs <span class="token operator">=</span> ofs<span class="token punctuation">;</span>
            ofs <span class="token operator">=</span> <span class="token punctuation">(</span>ofs <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ofs <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">// int overflow</span>
                ofs <span class="token operator">=</span> maxOfs<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ofs <span class="token operator">&gt;</span> maxOfs<span class="token punctuation">)</span>
            ofs <span class="token operator">=</span> maxOfs<span class="token punctuation">;</span>

        <span class="token comment">// Make offsets relative to base</span>
        lastOfs <span class="token operator">+=</span> hint<span class="token punctuation">;</span>
        ofs <span class="token operator">+=</span> hint<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// key &lt;= a[base + hint]</span>
        <span class="token comment">// Gallop left until a[base+hint-ofs] &lt; key &lt;= a[base+hint-lastOfs]</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> maxOfs <span class="token operator">=</span> hint <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>ofs <span class="token operator">&lt;</span> maxOfs <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> a<span class="token punctuation">[</span>base <span class="token operator">+</span> hint <span class="token operator">-</span> ofs<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lastOfs <span class="token operator">=</span> ofs<span class="token punctuation">;</span>
            ofs <span class="token operator">=</span> <span class="token punctuation">(</span>ofs <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ofs <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">// int overflow</span>
                ofs <span class="token operator">=</span> maxOfs<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ofs <span class="token operator">&gt;</span> maxOfs<span class="token punctuation">)</span>
            ofs <span class="token operator">=</span> maxOfs<span class="token punctuation">;</span>

        <span class="token comment">// Make offsets relative to base</span>
        <span class="token keyword">int</span> tmp <span class="token operator">=</span> lastOfs<span class="token punctuation">;</span>
        lastOfs <span class="token operator">=</span> hint <span class="token operator">-</span> ofs<span class="token punctuation">;</span>
        ofs <span class="token operator">=</span> hint <span class="token operator">-</span> tmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">assert</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;=</span> lastOfs <span class="token operator">&amp;&amp;</span> lastOfs <span class="token operator">&lt;</span> ofs <span class="token operator">&amp;&amp;</span> ofs <span class="token operator">&lt;=</span> len<span class="token punctuation">;</span>

    <span class="token comment">/*
        * Now a[base+lastOfs] &lt; key &lt;= a[base+ofs], so key belongs somewhere
        * to the right of lastOfs but no farther right than ofs.  Do a binary
        * search, with invariant a[base + lastOfs - 1] &lt; key &lt;= a[base + ofs].
        */</span>
    lastOfs<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>lastOfs <span class="token operator">&lt;</span> ofs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> m <span class="token operator">=</span> lastOfs <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ofs <span class="token operator">-</span> lastOfs<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> a<span class="token punctuation">[</span>base <span class="token operator">+</span> m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            lastOfs <span class="token operator">=</span> m <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// a[base + m] &lt; key</span>
        <span class="token keyword">else</span>
            ofs <span class="token operator">=</span> m<span class="token punctuation">;</span>          <span class="token comment">// key &lt;= a[base + m]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">assert</span> lastOfs <span class="token operator">==</span> ofs<span class="token punctuation">;</span>    <span class="token comment">// so a[base + ofs - 1] &lt; key &lt;= a[base + ofs]</span>
    <span class="token keyword">return</span> ofs<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">int</span> <span class="token function">gallopRight</span><span class="token punctuation">(</span><span class="token class-name">T</span> key<span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> base<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span>
                                    <span class="token keyword">int</span> hint<span class="token punctuation">,</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span> len <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> hint <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> hint <span class="token operator">&lt;</span> len<span class="token punctuation">;</span>

    <span class="token keyword">int</span> ofs <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> lastOfs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> a<span class="token punctuation">[</span>base <span class="token operator">+</span> hint<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Gallop left until a[b+hint - ofs] &lt;= key &lt; a[b+hint - lastOfs]</span>
        <span class="token keyword">int</span> maxOfs <span class="token operator">=</span> hint <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>ofs <span class="token operator">&lt;</span> maxOfs <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> a<span class="token punctuation">[</span>base <span class="token operator">+</span> hint <span class="token operator">-</span> ofs<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lastOfs <span class="token operator">=</span> ofs<span class="token punctuation">;</span>
            ofs <span class="token operator">=</span> <span class="token punctuation">(</span>ofs <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ofs <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">// int overflow</span>
                ofs <span class="token operator">=</span> maxOfs<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ofs <span class="token operator">&gt;</span> maxOfs<span class="token punctuation">)</span>
            ofs <span class="token operator">=</span> maxOfs<span class="token punctuation">;</span>

        <span class="token comment">// Make offsets relative to b</span>
        <span class="token keyword">int</span> tmp <span class="token operator">=</span> lastOfs<span class="token punctuation">;</span>
        lastOfs <span class="token operator">=</span> hint <span class="token operator">-</span> ofs<span class="token punctuation">;</span>
        ofs <span class="token operator">=</span> hint <span class="token operator">-</span> tmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// a[b + hint] &lt;= key</span>
        <span class="token comment">// Gallop right until a[b+hint + lastOfs] &lt;= key &lt; a[b+hint + ofs]</span>
        <span class="token keyword">int</span> maxOfs <span class="token operator">=</span> len <span class="token operator">-</span> hint<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>ofs <span class="token operator">&lt;</span> maxOfs <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> a<span class="token punctuation">[</span>base <span class="token operator">+</span> hint <span class="token operator">+</span> ofs<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lastOfs <span class="token operator">=</span> ofs<span class="token punctuation">;</span>
            ofs <span class="token operator">=</span> <span class="token punctuation">(</span>ofs <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ofs <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">// int overflow</span>
                ofs <span class="token operator">=</span> maxOfs<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ofs <span class="token operator">&gt;</span> maxOfs<span class="token punctuation">)</span>
            ofs <span class="token operator">=</span> maxOfs<span class="token punctuation">;</span>

        <span class="token comment">// Make offsets relative to b</span>
        lastOfs <span class="token operator">+=</span> hint<span class="token punctuation">;</span>
        ofs <span class="token operator">+=</span> hint<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">assert</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;=</span> lastOfs <span class="token operator">&amp;&amp;</span> lastOfs <span class="token operator">&lt;</span> ofs <span class="token operator">&amp;&amp;</span> ofs <span class="token operator">&lt;=</span> len<span class="token punctuation">;</span>

    <span class="token comment">/*
        * Now a[b + lastOfs] &lt;= key &lt; a[b + ofs], so key belongs somewhere to
        * the right of lastOfs but no farther right than ofs.  Do a binary
        * search, with invariant a[b + lastOfs - 1] &lt;= key &lt; a[b + ofs].
        */</span>
    lastOfs<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>lastOfs <span class="token operator">&lt;</span> ofs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> m <span class="token operator">=</span> lastOfs <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ofs <span class="token operator">-</span> lastOfs<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> a<span class="token punctuation">[</span>base <span class="token operator">+</span> m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            ofs <span class="token operator">=</span> m<span class="token punctuation">;</span>          <span class="token comment">// key &lt; a[b + m]</span>
        <span class="token keyword">else</span>
            lastOfs <span class="token operator">=</span> m <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// a[b + m] &lt;= key</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">assert</span> lastOfs <span class="token operator">==</span> ofs<span class="token punctuation">;</span>    <span class="token comment">// so a[b + ofs - 1] &lt;= key &lt; a[b + ofs]</span>
    <span class="token keyword">return</span> ofs<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">mergeLo</span><span class="token punctuation">(</span><span class="token keyword">int</span> base1<span class="token punctuation">,</span> <span class="token keyword">int</span> len1<span class="token punctuation">,</span> <span class="token keyword">int</span> base2<span class="token punctuation">,</span> <span class="token keyword">int</span> len2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span> len1 <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> len2 <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> base1 <span class="token operator">+</span> len1 <span class="token operator">==</span> base2<span class="token punctuation">;</span>

    <span class="token comment">// Copy first run into temp array</span>
    <span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">;</span> <span class="token comment">// For performance</span>
    <span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tmp <span class="token operator">=</span> <span class="token function">ensureCapacity</span><span class="token punctuation">(</span>len1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> cursor1 <span class="token operator">=</span> tmpBase<span class="token punctuation">;</span> <span class="token comment">// Indexes into tmp array</span>
    <span class="token keyword">int</span> cursor2 <span class="token operator">=</span> base2<span class="token punctuation">;</span>   <span class="token comment">// Indexes int a</span>
    <span class="token keyword">int</span> dest <span class="token operator">=</span> base1<span class="token punctuation">;</span>      <span class="token comment">// Indexes int a</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> base1<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> cursor1<span class="token punctuation">,</span> len1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Move first element of second run and deal with degenerate cases</span>
    a<span class="token punctuation">[</span>dest<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>cursor2<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>len2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> cursor1<span class="token punctuation">,</span> a<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> len1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len1 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> cursor2<span class="token punctuation">,</span> a<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> len2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        a<span class="token punctuation">[</span>dest <span class="token operator">+</span> len2<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">[</span>cursor1<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Last elt of run 1 to end of merge</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>c<span class="token punctuation">;</span>  <span class="token comment">// Use local variable for performance</span>
    <span class="token keyword">int</span> minGallop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minGallop<span class="token punctuation">;</span>    <span class="token comment">//  &quot;    &quot;       &quot;     &quot;      &quot;</span>
outer<span class="token operator">:</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> count1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Number of times in a row that first run won</span>
        <span class="token keyword">int</span> count2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Number of times in a row that second run won</span>

        <span class="token comment">/*
         * Do the straightforward thing until (if ever) one run starts
         * winning consistently.
         */</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">assert</span> len1 <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> len2 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>cursor2<span class="token punctuation">]</span><span class="token punctuation">,</span> tmp<span class="token punctuation">[</span>cursor1<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                a<span class="token punctuation">[</span>dest<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>cursor2<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                count2<span class="token operator">++</span><span class="token punctuation">;</span>
                count1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>len2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span> outer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                a<span class="token punctuation">[</span>dest<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">[</span>cursor1<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                count1<span class="token operator">++</span><span class="token punctuation">;</span>
                count2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>len1 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span> outer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>count1 <span class="token operator">|</span> count2<span class="token punctuation">)</span> <span class="token operator">&lt;</span> minGallop<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * One run is winning so consistently that galloping may be a
         * huge win. So try that, and continue galloping until (if ever)
         * neither run appears to be winning consistently anymore.
         */</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">assert</span> len1 <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> len2 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
            count1 <span class="token operator">=</span> <span class="token function">gallopRight</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>cursor2<span class="token punctuation">]</span><span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> cursor1<span class="token punctuation">,</span> len1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> cursor1<span class="token punctuation">,</span> a<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> count1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                dest <span class="token operator">+=</span> count1<span class="token punctuation">;</span>
                cursor1 <span class="token operator">+=</span> count1<span class="token punctuation">;</span>
                len1 <span class="token operator">-=</span> count1<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>len1 <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// len1 == 1 || len1 == 0</span>
                    <span class="token keyword">break</span> outer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            a<span class="token punctuation">[</span>dest<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>cursor2<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>len2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span> outer<span class="token punctuation">;</span>

            count2 <span class="token operator">=</span> <span class="token function">gallopLeft</span><span class="token punctuation">(</span>tmp<span class="token punctuation">[</span>cursor1<span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> cursor2<span class="token punctuation">,</span> len2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count2 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> cursor2<span class="token punctuation">,</span> a<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> count2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                dest <span class="token operator">+=</span> count2<span class="token punctuation">;</span>
                cursor2 <span class="token operator">+=</span> count2<span class="token punctuation">;</span>
                len2 <span class="token operator">-=</span> count2<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>len2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span> outer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            a<span class="token punctuation">[</span>dest<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">[</span>cursor1<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>len1 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span> outer<span class="token punctuation">;</span>
            minGallop<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>count1 <span class="token operator">&gt;=</span> MIN_GALLOP <span class="token operator">|</span> count2 <span class="token operator">&gt;=</span> MIN_GALLOP<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>minGallop <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            minGallop <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        minGallop <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// Penalize for leaving gallop mode</span>
    <span class="token punctuation">}</span>  <span class="token comment">// End of &quot;outer&quot; loop</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>minGallop <span class="token operator">=</span> minGallop <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> minGallop<span class="token punctuation">;</span>  <span class="token comment">// Write back to field</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>len1 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> len2 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> cursor2<span class="token punctuation">,</span> a<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> len2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        a<span class="token punctuation">[</span>dest <span class="token operator">+</span> len2<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">[</span>cursor1<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//  Last elt of run 1 to end of merge</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>len1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
            <span class="token string">&quot;Comparison method violates its general contract!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> len2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> len1 <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> cursor1<span class="token punctuation">,</span> a<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> len1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">mergeHi</span><span class="token punctuation">(</span><span class="token keyword">int</span> base1<span class="token punctuation">,</span> <span class="token keyword">int</span> len1<span class="token punctuation">,</span> <span class="token keyword">int</span> base2<span class="token punctuation">,</span> <span class="token keyword">int</span> len2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span> len1 <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> len2 <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> base1 <span class="token operator">+</span> len1 <span class="token operator">==</span> base2<span class="token punctuation">;</span>

    <span class="token comment">// Copy second run into temp array</span>
    <span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">;</span> <span class="token comment">// For performance</span>
    <span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tmp <span class="token operator">=</span> <span class="token function">ensureCapacity</span><span class="token punctuation">(</span>len2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> tmpBase <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tmpBase<span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> base2<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> tmpBase<span class="token punctuation">,</span> len2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> cursor1 <span class="token operator">=</span> base1 <span class="token operator">+</span> len1 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// Indexes into a</span>
    <span class="token keyword">int</span> cursor2 <span class="token operator">=</span> tmpBase <span class="token operator">+</span> len2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Indexes into tmp array</span>
    <span class="token keyword">int</span> dest <span class="token operator">=</span> base2 <span class="token operator">+</span> len2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">// Indexes into a</span>

    <span class="token comment">// Move last element of first run and deal with degenerate cases</span>
    a<span class="token punctuation">[</span>dest<span class="token operator">--</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>cursor1<span class="token operator">--</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>len1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> tmpBase<span class="token punctuation">,</span> a<span class="token punctuation">,</span> dest <span class="token operator">-</span> <span class="token punctuation">(</span>len2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> len2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len2 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dest <span class="token operator">-=</span> len1<span class="token punctuation">;</span>
        cursor1 <span class="token operator">-=</span> len1<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> cursor1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> dest <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> len1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        a<span class="token punctuation">[</span>dest<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">[</span>cursor2<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>c<span class="token punctuation">;</span>  <span class="token comment">// Use local variable for performance</span>
    <span class="token keyword">int</span> minGallop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minGallop<span class="token punctuation">;</span>    <span class="token comment">//  &quot;    &quot;       &quot;     &quot;      &quot;</span>
outer<span class="token operator">:</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> count1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Number of times in a row that first run won</span>
        <span class="token keyword">int</span> count2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Number of times in a row that second run won</span>

        <span class="token comment">/*
         * Do the straightforward thing until (if ever) one run
         * appears to win consistently.
         */</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">assert</span> len1 <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> len2 <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>tmp<span class="token punctuation">[</span>cursor2<span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span>cursor1<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                a<span class="token punctuation">[</span>dest<span class="token operator">--</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>cursor1<span class="token operator">--</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                count1<span class="token operator">++</span><span class="token punctuation">;</span>
                count2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>len1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span> outer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                a<span class="token punctuation">[</span>dest<span class="token operator">--</span><span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">[</span>cursor2<span class="token operator">--</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                count2<span class="token operator">++</span><span class="token punctuation">;</span>
                count1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>len2 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span> outer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>count1 <span class="token operator">|</span> count2<span class="token punctuation">)</span> <span class="token operator">&lt;</span> minGallop<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * One run is winning so consistently that galloping may be a
         * huge win. So try that, and continue galloping until (if ever)
         * neither run appears to be winning consistently anymore.
         */</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">assert</span> len1 <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> len2 <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
            count1 <span class="token operator">=</span> len1 <span class="token operator">-</span> <span class="token function">gallopRight</span><span class="token punctuation">(</span>tmp<span class="token punctuation">[</span>cursor2<span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> base1<span class="token punctuation">,</span> len1<span class="token punctuation">,</span> len1 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dest <span class="token operator">-=</span> count1<span class="token punctuation">;</span>
                cursor1 <span class="token operator">-=</span> count1<span class="token punctuation">;</span>
                len1 <span class="token operator">-=</span> count1<span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> cursor1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> dest <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> count1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>len1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span> outer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            a<span class="token punctuation">[</span>dest<span class="token operator">--</span><span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">[</span>cursor2<span class="token operator">--</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>len2 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span> outer<span class="token punctuation">;</span>

            count2 <span class="token operator">=</span> len2 <span class="token operator">-</span> <span class="token function">gallopLeft</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>cursor1<span class="token punctuation">]</span><span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> tmpBase<span class="token punctuation">,</span> len2<span class="token punctuation">,</span> len2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count2 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dest <span class="token operator">-=</span> count2<span class="token punctuation">;</span>
                cursor2 <span class="token operator">-=</span> count2<span class="token punctuation">;</span>
                len2 <span class="token operator">-=</span> count2<span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> cursor2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> dest <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> count2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>len2 <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">// len2 == 1 || len2 == 0</span>
                    <span class="token keyword">break</span> outer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            a<span class="token punctuation">[</span>dest<span class="token operator">--</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>cursor1<span class="token operator">--</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>len1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span> outer<span class="token punctuation">;</span>
            minGallop<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>count1 <span class="token operator">&gt;=</span> MIN_GALLOP <span class="token operator">|</span> count2 <span class="token operator">&gt;=</span> MIN_GALLOP<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>minGallop <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            minGallop <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        minGallop <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// Penalize for leaving gallop mode</span>
    <span class="token punctuation">}</span>  <span class="token comment">// End of &quot;outer&quot; loop</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>minGallop <span class="token operator">=</span> minGallop <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> minGallop<span class="token punctuation">;</span>  <span class="token comment">// Write back to field</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>len2 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> len1 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
        dest <span class="token operator">-=</span> len1<span class="token punctuation">;</span>
        cursor1 <span class="token operator">-=</span> len1<span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> cursor1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> dest <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> len1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        a<span class="token punctuation">[</span>dest<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">[</span>cursor2<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// Move first elt of run2 to front of merge</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>len2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
            <span class="token string">&quot;Comparison method violates its general contract!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> len1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> len2 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> tmpBase<span class="token punctuation">,</span> a<span class="token punctuation">,</span> dest <span class="token operator">-</span> <span class="token punctuation">(</span>len2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> len2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="dualpivotquicksort-sort"><a href="#dualpivotquicksort-sort" class="header-anchor">#</a> DualPivotQuicksort#sort</h3> <p>下面，再看一下jdk中实现的双轴快排算法。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * The maximum number of runs in merge sort.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_RUN_COUNT <span class="token operator">=</span> <span class="token number">67</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * The maximum length of run in merge sort.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_RUN_LENGTH <span class="token operator">=</span> <span class="token number">33</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * If the length of an array to be sorted is less than this
 * constant, Quicksort is used in preference to merge sort.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> QUICKSORT_THRESHOLD <span class="token operator">=</span> <span class="token number">286</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * If the length of an array to be sorted is less than this
 * constant, insertion sort is used in preference to Quicksort.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> INSERTION_SORT_THRESHOLD <span class="token operator">=</span> <span class="token number">47</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * If the length of a byte array to be sorted is greater than this
 * constant, counting sort is used in preference to insertion sort.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> COUNTING_SORT_THRESHOLD_FOR_BYTE <span class="token operator">=</span> <span class="token number">29</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * If the length of a short or char array to be sorted is greater
 * than this constant, counting sort is used in preference to Quicksort.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> COUNTING_SORT_THRESHOLD_FOR_SHORT_OR_CHAR <span class="token operator">=</span> <span class="token number">3200</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * Sorts the specified range of the array using the given
 * workspace array slice if possible for merging
 *
 * @param a the array to be sorted
 * @param left the index of the first element, inclusive, to be sorted
 * @param right the index of the last element, inclusive, to be sorted
 * @param work a workspace array (slice)
 * @param workBase origin of usable space in work array
 * @param workLen usable size of work array
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span>
                    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> work<span class="token punctuation">,</span> <span class="token keyword">int</span> workBase<span class="token punctuation">,</span> <span class="token keyword">int</span> workLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Use Quicksort on small arrays</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>right <span class="token operator">-</span> left <span class="token operator">&lt;</span> QUICKSORT_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sort</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
     * Index run[i] is the start of i-th run
     * (ascending or descending sequence).
     */</span>
    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> run <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>MAX_RUN_COUNT <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> run<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> left<span class="token punctuation">;</span>

    <span class="token comment">// Check if the array is nearly sorted</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> left<span class="token punctuation">;</span> k <span class="token operator">&lt;</span> right<span class="token punctuation">;</span> run<span class="token punctuation">[</span>count<span class="token punctuation">]</span> <span class="token operator">=</span> k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">&lt;</span> a<span class="token punctuation">[</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// ascending</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">++</span>k <span class="token operator">&lt;=</span> right <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">[</span>k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> a<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">&gt;</span> a<span class="token punctuation">[</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// descending</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">++</span>k <span class="token operator">&lt;=</span> right <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">[</span>k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> a<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> lo <span class="token operator">=</span> run<span class="token punctuation">[</span>count<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> hi <span class="token operator">=</span> k<span class="token punctuation">;</span> <span class="token operator">++</span>lo <span class="token operator">&lt;</span> <span class="token operator">--</span>hi<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> t <span class="token operator">=</span> a<span class="token punctuation">[</span>lo<span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>lo<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>hi<span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>hi<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// equal</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> m <span class="token operator">=</span> MAX_RUN_LENGTH<span class="token punctuation">;</span> <span class="token operator">++</span>k <span class="token operator">&lt;=</span> right <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">[</span>k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> a<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>m <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">sort</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/*
         * The array is not highly structured,
         * use Quicksort instead of merge sort.
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count <span class="token operator">==</span> MAX_RUN_COUNT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sort</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Check special cases</span>
    <span class="token comment">// Implementation note: variable &quot;right&quot; is increased by 1.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>run<span class="token punctuation">[</span>count<span class="token punctuation">]</span> <span class="token operator">==</span> right<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// The last run contains one element</span>
        run<span class="token punctuation">[</span><span class="token operator">++</span>count<span class="token punctuation">]</span> <span class="token operator">=</span> right<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// The array is already sorted</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Determine alternation base for merge</span>
    <span class="token keyword">byte</span> odd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> odd <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Use or create temporary array b for merging</span>
    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">;</span>                 <span class="token comment">// temp array; alternates with a</span>
    <span class="token keyword">int</span> ao<span class="token punctuation">,</span> bo<span class="token punctuation">;</span>              <span class="token comment">// array offsets from 'left'</span>
    <span class="token keyword">int</span> blen <span class="token operator">=</span> right <span class="token operator">-</span> left<span class="token punctuation">;</span> <span class="token comment">// space needed for b</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>work <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> workLen <span class="token operator">&lt;</span> blen <span class="token operator">||</span> workBase <span class="token operator">+</span> blen <span class="token operator">&gt;</span> work<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        work <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>blen<span class="token punctuation">]</span><span class="token punctuation">;</span>
        workBase <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>odd <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> left<span class="token punctuation">,</span> work<span class="token punctuation">,</span> workBase<span class="token punctuation">,</span> blen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        b <span class="token operator">=</span> a<span class="token punctuation">;</span>
        bo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        a <span class="token operator">=</span> work<span class="token punctuation">;</span>
        ao <span class="token operator">=</span> workBase <span class="token operator">-</span> left<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        b <span class="token operator">=</span> work<span class="token punctuation">;</span>
        ao <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        bo <span class="token operator">=</span> workBase <span class="token operator">-</span> left<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Merging</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> last<span class="token punctuation">;</span> count <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span> count <span class="token operator">=</span> last<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token punctuation">(</span>last <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span> k <span class="token operator">&lt;=</span> count<span class="token punctuation">;</span> k <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> hi <span class="token operator">=</span> run<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> mi <span class="token operator">=</span> run<span class="token punctuation">[</span>k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> run<span class="token punctuation">[</span>k <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> p <span class="token operator">=</span> i<span class="token punctuation">,</span> q <span class="token operator">=</span> mi<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> hi<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">&gt;=</span> hi <span class="token operator">||</span> p <span class="token operator">&lt;</span> mi <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">[</span>p <span class="token operator">+</span> ao<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> a<span class="token punctuation">[</span>q <span class="token operator">+</span> ao<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    b<span class="token punctuation">[</span>i <span class="token operator">+</span> bo<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>p<span class="token operator">++</span> <span class="token operator">+</span> ao<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    b<span class="token punctuation">[</span>i <span class="token operator">+</span> bo<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>q<span class="token operator">++</span> <span class="token operator">+</span> ao<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            run<span class="token punctuation">[</span><span class="token operator">++</span>last<span class="token punctuation">]</span> <span class="token operator">=</span> hi<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>count <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> right<span class="token punctuation">,</span> lo <span class="token operator">=</span> run<span class="token punctuation">[</span>count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">--</span>i <span class="token operator">&gt;=</span> lo<span class="token punctuation">;</span>
                b<span class="token punctuation">[</span>i <span class="token operator">+</span> bo<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>i <span class="token operator">+</span> ao<span class="token punctuation">]</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            run<span class="token punctuation">[</span><span class="token operator">++</span>last<span class="token punctuation">]</span> <span class="token operator">=</span> right<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> t <span class="token operator">=</span> a<span class="token punctuation">;</span> a <span class="token operator">=</span> b<span class="token punctuation">;</span> b <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token keyword">int</span> o <span class="token operator">=</span> ao<span class="token punctuation">;</span> ao <span class="token operator">=</span> bo<span class="token punctuation">;</span> bo <span class="token operator">=</span> o<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Sorts the specified range of the array by Dual-Pivot Quicksort.
 *
 * @param a the array to be sorted
 * @param left the index of the first element, inclusive, to be sorted
 * @param right the index of the last element, inclusive, to be sorted
 * @param leftmost indicates if this part is the leftmost in the range
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span> <span class="token keyword">boolean</span> leftmost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> length <span class="token operator">=</span> right <span class="token operator">-</span> left <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// Use insertion sort on tiny arrays</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;</span> INSERTION_SORT_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>leftmost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*
             * Traditional (without sentinel) insertion sort,
             * optimized for server VM, is used in case of
             * the leftmost part.
             */</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> left<span class="token punctuation">,</span> j <span class="token operator">=</span> i<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> right<span class="token punctuation">;</span> j <span class="token operator">=</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> ai <span class="token operator">=</span> a<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>ai <span class="token operator">&lt;</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    a<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>j<span class="token operator">--</span> <span class="token operator">==</span> left<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                a<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> ai<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">/*
             * Skip the longest ascending sequence.
             */</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">&gt;=</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token operator">++</span>left<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> a<span class="token punctuation">[</span>left <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/*
             * Every element from adjoining part plays the role
             * of sentinel, therefore this allows us to avoid the
             * left range check on each iteration. Moreover, we use
             * the more optimized algorithm, so called pair insertion
             * sort, which is faster (in the context of Quicksort)
             * than traditional implementation of insertion sort.
             */</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> left<span class="token punctuation">;</span> <span class="token operator">++</span>left <span class="token operator">&lt;=</span> right<span class="token punctuation">;</span> k <span class="token operator">=</span> <span class="token operator">++</span>left<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> a1 <span class="token operator">=</span> a<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">,</span> a2 <span class="token operator">=</span> a<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>a1 <span class="token operator">&lt;</span> a2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    a2 <span class="token operator">=</span> a1<span class="token punctuation">;</span> a1 <span class="token operator">=</span> a<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>a1 <span class="token operator">&lt;</span> a<span class="token punctuation">[</span><span class="token operator">--</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    a<span class="token punctuation">[</span>k <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                a<span class="token punctuation">[</span><span class="token operator">++</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> a1<span class="token punctuation">;</span>

                <span class="token keyword">while</span> <span class="token punctuation">(</span>a2 <span class="token operator">&lt;</span> a<span class="token punctuation">[</span><span class="token operator">--</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    a<span class="token punctuation">[</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                a<span class="token punctuation">[</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> a2<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> last <span class="token operator">=</span> a<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span>last <span class="token operator">&lt;</span> a<span class="token punctuation">[</span><span class="token operator">--</span>right<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                a<span class="token punctuation">[</span>right <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            a<span class="token punctuation">[</span>right <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> last<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Inexpensive approximation of length / 7</span>
    <span class="token keyword">int</span> seventh <span class="token operator">=</span> <span class="token punctuation">(</span>length <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>length <span class="token operator">&gt;&gt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">/*
     * Sort five evenly spaced elements around (and including) the
     * center element in the range. These elements will be used for
     * pivot selection as described below. The choice for spacing
     * these elements was empirically determined to work well on
     * a wide variety of inputs.
     */</span>
    <span class="token keyword">int</span> e3 <span class="token operator">=</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> right<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// The midpoint</span>
    <span class="token keyword">int</span> e2 <span class="token operator">=</span> e3 <span class="token operator">-</span> seventh<span class="token punctuation">;</span>
    <span class="token keyword">int</span> e1 <span class="token operator">=</span> e2 <span class="token operator">-</span> seventh<span class="token punctuation">;</span>
    <span class="token keyword">int</span> e4 <span class="token operator">=</span> e3 <span class="token operator">+</span> seventh<span class="token punctuation">;</span>
    <span class="token keyword">int</span> e5 <span class="token operator">=</span> e4 <span class="token operator">+</span> seventh<span class="token punctuation">;</span>

    <span class="token comment">// Sort these elements using insertion sort</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token operator">&lt;</span> a<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">int</span> t <span class="token operator">=</span> a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>e1<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>e3<span class="token punctuation">]</span> <span class="token operator">&lt;</span> a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">int</span> t <span class="token operator">=</span> a<span class="token punctuation">[</span>e3<span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>e3<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;</span> a<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>e1<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>e4<span class="token punctuation">]</span> <span class="token operator">&lt;</span> a<span class="token punctuation">[</span>e3<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">int</span> t <span class="token operator">=</span> a<span class="token punctuation">[</span>e4<span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>e4<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>e3<span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>e3<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;</span> a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> a<span class="token punctuation">[</span>e3<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;</span> a<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>e1<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>e5<span class="token punctuation">]</span> <span class="token operator">&lt;</span> a<span class="token punctuation">[</span>e4<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">int</span> t <span class="token operator">=</span> a<span class="token punctuation">[</span>e5<span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>e5<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>e4<span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>e4<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;</span> a<span class="token punctuation">[</span>e3<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> a<span class="token punctuation">[</span>e4<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>e3<span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>e3<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;</span> a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> a<span class="token punctuation">[</span>e3<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;</span> a<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>e1<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Pointers</span>
    <span class="token keyword">int</span> less  <span class="token operator">=</span> left<span class="token punctuation">;</span>  <span class="token comment">// The index of the first element of center part</span>
    <span class="token keyword">int</span> great <span class="token operator">=</span> right<span class="token punctuation">;</span> <span class="token comment">// The index before the first element of right part</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>e1<span class="token punctuation">]</span> <span class="token operator">!=</span> a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token operator">!=</span> a<span class="token punctuation">[</span>e3<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">[</span>e3<span class="token punctuation">]</span> <span class="token operator">!=</span> a<span class="token punctuation">[</span>e4<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">[</span>e4<span class="token punctuation">]</span> <span class="token operator">!=</span> a<span class="token punctuation">[</span>e5<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/*
         * Use the second and fourth of the five sorted elements as pivots.
         * These values are inexpensive approximations of the first and
         * second terciles of the array. Note that pivot1 &lt;= pivot2.
         */</span>
        <span class="token keyword">int</span> pivot1 <span class="token operator">=</span> a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> pivot2 <span class="token operator">=</span> a<span class="token punctuation">[</span>e4<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * The first and the last elements to be sorted are moved to the
         * locations formerly occupied by the pivots. When partitioning
         * is complete, the pivots are swapped back into their final
         * positions, and excluded from subsequent sorting.
         */</span>
        a<span class="token punctuation">[</span>e2<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">;</span>
        a<span class="token punctuation">[</span>e4<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * Skip elements, which are less or greater than pivot values.
         */</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token operator">++</span>less<span class="token punctuation">]</span> <span class="token operator">&lt;</span> pivot1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token operator">--</span>great<span class="token punctuation">]</span> <span class="token operator">&gt;</span> pivot2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
         * Partitioning:
         *
         *   left part           center part                   right part
         * +--------------------------------------------------------------+
         * |  &lt; pivot1  |  pivot1 &lt;= &amp;&amp; &lt;= pivot2  |    ?    |  &gt; pivot2  |
         * +--------------------------------------------------------------+
         *               ^                          ^       ^
         *               |                          |       |
         *              less                        k     great
         *
         * Invariants:
         *
         *              all in (left, less)   &lt; pivot1
         *    pivot1 &lt;= all in [less, k)     &lt;= pivot2
         *              all in (great, right) &gt; pivot2
         *
         * Pointer k is the first index of ?-part.
         */</span>
        outer<span class="token operator">:</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> less <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>k <span class="token operator">&lt;=</span> great<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> ak <span class="token operator">=</span> a<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ak <span class="token operator">&lt;</span> pivot1<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Move a[k] to left part</span>
                a<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>less<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token comment">/*
                 * Here and below we use &quot;a[i] = b; i++;&quot; instead
                 * of &quot;a[i++] = b;&quot; due to performance issue.
                 */</span>
                a<span class="token punctuation">[</span>less<span class="token punctuation">]</span> <span class="token operator">=</span> ak<span class="token punctuation">;</span>
                <span class="token operator">++</span>less<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ak <span class="token operator">&gt;</span> pivot2<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Move a[k] to right part</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>great<span class="token punctuation">]</span> <span class="token operator">&gt;</span> pivot2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>great<span class="token operator">--</span> <span class="token operator">==</span> k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span> outer<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>great<span class="token punctuation">]</span> <span class="token operator">&lt;</span> pivot1<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// a[great] &lt;= pivot2</span>
                    a<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>less<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    a<span class="token punctuation">[</span>less<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>great<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token operator">++</span>less<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// pivot1 &lt;= a[great] &lt;= pivot2</span>
                    a<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>great<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">/*
                 * Here and below we use &quot;a[i] = b; i--;&quot; instead
                 * of &quot;a[i--] = b;&quot; due to performance issue.
                 */</span>
                a<span class="token punctuation">[</span>great<span class="token punctuation">]</span> <span class="token operator">=</span> ak<span class="token punctuation">;</span>
                <span class="token operator">--</span>great<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Swap pivots into their final positions</span>
        a<span class="token punctuation">[</span>left<span class="token punctuation">]</span>  <span class="token operator">=</span> a<span class="token punctuation">[</span>less  <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>less  <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> pivot1<span class="token punctuation">;</span>
        a<span class="token punctuation">[</span>right<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>great <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> a<span class="token punctuation">[</span>great <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> pivot2<span class="token punctuation">;</span>

        <span class="token comment">// Sort left and right parts recursively, excluding known pivots</span>
        <span class="token function">sort</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> left<span class="token punctuation">,</span> less <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> leftmost<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sort</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> great <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> right<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
            * If center part is too large (comprises &gt; 4/7 of the array),
            * swap internal pivot values to ends.
            */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>less <span class="token operator">&lt;</span> e1 <span class="token operator">&amp;&amp;</span> e5 <span class="token operator">&lt;</span> great<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/*
                * Skip elements, which are equal to pivot values.
                */</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>less<span class="token punctuation">]</span> <span class="token operator">==</span> pivot1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token operator">++</span>less<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>great<span class="token punctuation">]</span> <span class="token operator">==</span> pivot2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token operator">--</span>great<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/*
                * Partitioning:
                *
                *   left part         center part                  right part
                * +----------------------------------------------------------+
                * | == pivot1 |  pivot1 &lt; &amp;&amp; &lt; pivot2  |    ?    | == pivot2 |
                * +----------------------------------------------------------+
                *              ^                        ^       ^
                *              |                        |       |
                *             less                      k     great
                *
                * Invariants:
                *
                *              all in (*,  less) == pivot1
                *     pivot1 &lt; all in [less,  k)  &lt; pivot2
                *              all in (great, *) == pivot2
                *
                * Pointer k is the first index of ?-part.
                */</span>
            outer<span class="token operator">:</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> less <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">++</span>k <span class="token operator">&lt;=</span> great<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> ak <span class="token operator">=</span> a<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ak <span class="token operator">==</span> pivot1<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Move a[k] to left part</span>
                    a<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>less<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    a<span class="token punctuation">[</span>less<span class="token punctuation">]</span> <span class="token operator">=</span> ak<span class="token punctuation">;</span>
                    <span class="token operator">++</span>less<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ak <span class="token operator">==</span> pivot2<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Move a[k] to right part</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>great<span class="token punctuation">]</span> <span class="token operator">==</span> pivot2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>great<span class="token operator">--</span> <span class="token operator">==</span> k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">break</span> outer<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>great<span class="token punctuation">]</span> <span class="token operator">==</span> pivot1<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// a[great] &lt; pivot2</span>
                        a<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>less<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token comment">/*
                            * Even though a[great] equals to pivot1, the
                            * assignment a[less] = pivot1 may be incorrect,
                            * if a[great] and pivot1 are floating-point zeros
                            * of different signs. Therefore in float and
                            * double sorting methods we have to use more
                            * accurate assignment a[less] = a[great].
                            */</span>
                        a<span class="token punctuation">[</span>less<span class="token punctuation">]</span> <span class="token operator">=</span> pivot1<span class="token punctuation">;</span>
                        <span class="token operator">++</span>less<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// pivot1 &lt; a[great] &lt; pivot2</span>
                        a<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>great<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    a<span class="token punctuation">[</span>great<span class="token punctuation">]</span> <span class="token operator">=</span> ak<span class="token punctuation">;</span>
                    <span class="token operator">--</span>great<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Sort center part recursively</span>
        <span class="token function">sort</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> less<span class="token punctuation">,</span> great<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// Partitioning with one pivot</span>
        <span class="token comment">/*
            * Use the third of the five sorted elements as pivot.
            * This value is inexpensive approximation of the median.
            */</span>
        <span class="token keyword">int</span> pivot <span class="token operator">=</span> a<span class="token punctuation">[</span>e3<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">/*
            * Partitioning degenerates to the traditional 3-way
            * (or &quot;Dutch National Flag&quot;) schema:
            *
            *   left part    center part              right part
            * +-------------------------------------------------+
            * |  &lt; pivot  |   == pivot   |     ?    |  &gt; pivot  |
            * +-------------------------------------------------+
            *              ^              ^        ^
            *              |              |        |
            *             less            k      great
            *
            * Invariants:
            *
            *   all in (left, less)   &lt; pivot
            *   all in [less, k)     == pivot
            *   all in (great, right) &gt; pivot
            *
            * Pointer k is the first index of ?-part.
            */</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> less<span class="token punctuation">;</span> k <span class="token operator">&lt;=</span> great<span class="token punctuation">;</span> <span class="token operator">++</span>k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">==</span> pivot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> ak <span class="token operator">=</span> a<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ak <span class="token operator">&lt;</span> pivot<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Move a[k] to left part</span>
                a<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>less<span class="token punctuation">]</span><span class="token punctuation">;</span>
                a<span class="token punctuation">[</span>less<span class="token punctuation">]</span> <span class="token operator">=</span> ak<span class="token punctuation">;</span>
                <span class="token operator">++</span>less<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// a[k] &gt; pivot - Move a[k] to right part</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>great<span class="token punctuation">]</span> <span class="token operator">&gt;</span> pivot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token operator">--</span>great<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>great<span class="token punctuation">]</span> <span class="token operator">&lt;</span> pivot<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// a[great] &lt;= pivot</span>
                    a<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>less<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    a<span class="token punctuation">[</span>less<span class="token punctuation">]</span> <span class="token operator">=</span> a<span class="token punctuation">[</span>great<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token operator">++</span>less<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// a[great] == pivot</span>
                    <span class="token comment">/*
                        * Even though a[great] equals to pivot, the
                        * assignment a[k] = pivot may be incorrect,
                        * if a[great] and pivot are floating-point
                        * zeros of different signs. Therefore in float
                        * and double sorting methods we have to use
                        * more accurate assignment a[k] = a[great].
                        */</span>
                    a<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> pivot<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                a<span class="token punctuation">[</span>great<span class="token punctuation">]</span> <span class="token operator">=</span> ak<span class="token punctuation">;</span>
                <span class="token operator">--</span>great<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/*
            * Sort left and right parts recursively.
            * All elements from center part are equal
            * and, therefore, already sorted.
            */</span>
        <span class="token function">sort</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> left<span class="token punctuation">,</span> less <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> leftmost<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sort</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> great <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> right<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="扩展"><a href="#扩展" class="header-anchor">#</a> 扩展</h2> <h3 id="arrays-legacymergesort"><a href="#arrays-legacymergesort" class="header-anchor">#</a> Arrays#legacyMergeSort</h3> <p><code>Arrays</code>中同样也实现了原始的归并排序，但是默认是不启用的，下面也稍微分析下。</p> <p>其实这个归并排序的实现还是比较常规的，只不过是多了一层判断，如果待排序的数组长度小于INSERTIONSORT_THRESHOLD这个阈值，那就直接使用插入排序了。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 方法名定义的很明显，原始归并排序</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">legacyMergeSort</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span>
                                    <span class="token keyword">int</span> fromIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> toIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 因为fromIndex、toIndex不一定是从0到length-1，所以这里把区间内的原始copy到了一个新数组中</span>
    <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aux <span class="token operator">=</span> <span class="token function">copyOfRange</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> fromIndex<span class="token punctuation">,</span> toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用归并排序</span>
    <span class="token function">mergeSort</span><span class="token punctuation">(</span>aux<span class="token punctuation">,</span> a<span class="token punctuation">,</span> fromIndex<span class="token punctuation">,</span> toIndex<span class="token punctuation">,</span> <span class="token operator">-</span>fromIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">mergeSort</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> src<span class="token punctuation">,</span>
                              <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dest<span class="token punctuation">,</span>
                              <span class="token keyword">int</span> low<span class="token punctuation">,</span>
                              <span class="token keyword">int</span> high<span class="token punctuation">,</span>
                              <span class="token keyword">int</span> off<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取待排序的长度</span>
    <span class="token keyword">int</span> length <span class="token operator">=</span> high <span class="token operator">-</span> low<span class="token punctuation">;</span>
	<span class="token comment">// 如果长度小于7，那就直接通过插入排序实现</span>
    <span class="token comment">// Insertion sort on smallest arrays</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;</span> INSERTIONSORT_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 两层for循环，</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>low<span class="token punctuation">;</span> i<span class="token operator">&lt;</span>high<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span>i<span class="token punctuation">;</span> j<span class="token operator">&gt;</span>low <span class="token operator">&amp;&amp;</span>
                 <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Comparable</span><span class="token punctuation">)</span> dest<span class="token punctuation">[</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>dest<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span>
                <span class="token function">swap</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> j<span class="token punctuation">,</span> j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Recursively sort halves of dest into src</span>
    <span class="token comment">// 原本的起始下标</span>
    <span class="token keyword">int</span> destLow  <span class="token operator">=</span> low<span class="token punctuation">;</span>
    <span class="token comment">// 原本的结束下标</span>
    <span class="token keyword">int</span> destHigh <span class="token operator">=</span> high<span class="token punctuation">;</span>
    <span class="token comment">// 根据方法的调用链可以看到，off=-low</span>
    <span class="token comment">// 那么这里，low == 0</span>
    low  <span class="token operator">+=</span> off<span class="token punctuation">;</span>
    <span class="token comment">// high == destHigh-destLow</span>
    high <span class="token operator">+=</span> off<span class="token punctuation">;</span>
    <span class="token comment">// 找到中间位置</span>
    <span class="token keyword">int</span> mid <span class="token operator">=</span> <span class="token punctuation">(</span>low <span class="token operator">+</span> high<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">mergeSort</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> src<span class="token punctuation">,</span> low<span class="token punctuation">,</span> mid<span class="token punctuation">,</span> <span class="token operator">-</span>off<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mergeSort</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> src<span class="token punctuation">,</span> mid<span class="token punctuation">,</span> high<span class="token punctuation">,</span> <span class="token operator">-</span>off<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// If list is already sorted, just copy from src to dest.  This is an</span>
    <span class="token comment">// optimization that results in faster sorts for nearly ordered lists.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Comparable</span><span class="token punctuation">)</span>src<span class="token punctuation">[</span>mid<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>src<span class="token punctuation">[</span>mid<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> low<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> destLow<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Merge sorted halves (now in src) into dest</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> destLow<span class="token punctuation">,</span> p <span class="token operator">=</span> low<span class="token punctuation">,</span> q <span class="token operator">=</span> mid<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> destHigh<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">&gt;=</span> high <span class="token operator">||</span> p <span class="token operator">&lt;</span> mid <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Comparable</span><span class="token punctuation">)</span>src<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>src<span class="token punctuation">[</span>q<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span>
            dest<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> src<span class="token punctuation">[</span>p<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            dest<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> src<span class="token punctuation">[</span>q<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="arrays-binarysearch"><a href="#arrays-binarysearch" class="header-anchor">#</a> Arrays#binarySearch</h3> <p><code>Arrays</code>类还实现了二分查找，最后就简单分析下吧。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 在整个数组内，查找是否存在元素key</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">binarySearch0</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>length<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// // 在数组的from到to区间内，查找是否存在元素key</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binarySearch</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> fromIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> toIndex<span class="token punctuation">,</span>
                               <span class="token keyword">int</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 对于下标是否越界的check</span>
  <span class="token function">rangeCheck</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>length<span class="token punctuation">,</span> fromIndex<span class="token punctuation">,</span> toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 调用二分查找的实现方法</span>
  <span class="token keyword">return</span> <span class="token function">binarySearch0</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> fromIndex<span class="token punctuation">,</span> toIndex<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binarySearch0</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> fromIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> toIndex<span class="token punctuation">,</span>
                                 <span class="token keyword">int</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 起始下标</span>
  <span class="token keyword">int</span> low <span class="token operator">=</span> fromIndex<span class="token punctuation">;</span>
  <span class="token comment">// 结束下标</span>
  <span class="token keyword">int</span> high <span class="token operator">=</span> toIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">// 循环的实现方式</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>low <span class="token operator">&lt;=</span> high<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 找到中间位置的下标</span>
    <span class="token keyword">int</span> mid <span class="token operator">=</span> <span class="token punctuation">(</span>low <span class="token operator">+</span> high<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 取中间值</span>
    <span class="token keyword">int</span> midVal <span class="token operator">=</span> a<span class="token punctuation">[</span>mid<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">// 如果中间值小于目标值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>midVal <span class="token operator">&lt;</span> key<span class="token punctuation">)</span>
      <span class="token comment">// 把起始下标移到mid+1处</span>
      low <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果中间值大于目标值</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>midVal <span class="token operator">&gt;</span> key<span class="token punctuation">)</span>
      <span class="token comment">// 把结束下标移到mid-1处</span>
      high <span class="token operator">=</span> mid <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      <span class="token comment">// 否则，二者相等，直接返回中间位置的下标</span>
      <span class="token keyword">return</span> mid<span class="token punctuation">;</span> <span class="token comment">// key found</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 一旦while循环结束，代码执行到这里，代表没有找到，返回一个负值</span>
  <span class="token keyword">return</span> <span class="token operator">-</span><span class="token punctuation">(</span>low <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// key not found.</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ol><li><a href="https://www.cnblogs.com/warehouse/p/9342279.html" target="_blank" rel="noopener noreferrer">JDK（二）JDK1.8源码分析【排序】timsort<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol></div> <footer class="page-edit" style="display:none;"><div class="edit-link"><a href="https://github.com/itForeverYoung/blog/edit/master/docs/java/jdk-sort.md" target="_blank" rel="noopener noreferrer">在GitHub上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新时间: </span> <span class="time">2020/10/27 下午4:14:01</span></div></footer> <!----> <!----> <!----></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.ecde336a.js" defer></script><script src="/assets/js/3.86996c84.js" defer></script><script src="/assets/js/1.31384522.js" defer></script><script src="/assets/js/85.5adee6bb.js" defer></script>
  </body>
</html>

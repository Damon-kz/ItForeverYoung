# Redis 过期删除策略

## 基础

```json
// redis.conf
// 配置serverCron任务的执行频率，默认：10次/每秒
hz 10
```

**Redis的过期删除策略有两种，一种被动删除，一种主动删除。**

**key过期信息存储为绝对的Unix时间戳（ms），这代表Redis的过期策略，对宿主机器时间的稳定性有强要求。**

### 主节点的过期key处理

1. 被动删除，当有客户端访问一个key时，Redis会检测这个key是否过期，如果过期，会删除这个key。

2. 主动删除，CPU空闲时，执行serverCron定时任务，执行周期为每秒10次（可通过修改配置属性"hz"来修改执行周期），任务分为以下几个步骤：
   1. 每次过期清理时间不超过CPU时间的25%，
   2. 随机选择20个key，判断它们是否过期，如果过期，则删除，
   3. 如果发现一次选择中，有超过25%（默认情况下就是5个）的key都过期了，则重复步骤2，直到随机选择中，过期的key百分比低于25%。

### 从节点和aof文件的过期key处理

1. 当主节点判断到一个key过期后，就会对这些key执行del命令；
2. 主节点执行的del操作会持久化到aof文件并且同步给从节点，这样从节点就会删除这个key；
3. 从节点不会主动执行删除操作，所以，当一个key过期了，但是主节点还没有同步过来del命令时，客户端还是可以在从节点获取到这个key；
4. 这样的话，过期删除的操作就集中在主节点上，aof文件和从节点只需要添加和执行同步过来的del命令即可。

## 源码分析

```c
// expire.c
```

## 总结


<!DOCTYPE html>
<html lang="简体中文">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Boot 启动流程 | IT Forever Young</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="IT Forever Young">
    <link rel="preload" href="/assets/css/0.styles.3d89bc54.css" as="style"><link rel="preload" href="/assets/js/app.8adec5b5.js" as="script"><link rel="preload" href="/assets/js/2.2552ee46.js" as="script"><link rel="preload" href="/assets/js/3.b0bf1cd6.js" as="script"><link rel="prefetch" href="/assets/js/10.c2843c64.js"><link rel="prefetch" href="/assets/js/11.abe71dd0.js"><link rel="prefetch" href="/assets/js/12.256e6fa5.js"><link rel="prefetch" href="/assets/js/13.999bca14.js"><link rel="prefetch" href="/assets/js/14.1a898b12.js"><link rel="prefetch" href="/assets/js/15.fea95fc5.js"><link rel="prefetch" href="/assets/js/16.0291c11a.js"><link rel="prefetch" href="/assets/js/17.c4f3c000.js"><link rel="prefetch" href="/assets/js/18.0986cbee.js"><link rel="prefetch" href="/assets/js/19.24be17cd.js"><link rel="prefetch" href="/assets/js/20.8a0325b5.js"><link rel="prefetch" href="/assets/js/21.fe92e7fa.js"><link rel="prefetch" href="/assets/js/22.8179d7eb.js"><link rel="prefetch" href="/assets/js/23.a1b82175.js"><link rel="prefetch" href="/assets/js/24.102e0529.js"><link rel="prefetch" href="/assets/js/25.66bf58b1.js"><link rel="prefetch" href="/assets/js/26.14b7e24d.js"><link rel="prefetch" href="/assets/js/27.1d29a65b.js"><link rel="prefetch" href="/assets/js/28.2cac0b29.js"><link rel="prefetch" href="/assets/js/29.9987c9a8.js"><link rel="prefetch" href="/assets/js/30.1b4eb2f5.js"><link rel="prefetch" href="/assets/js/31.432693bb.js"><link rel="prefetch" href="/assets/js/32.a11c53da.js"><link rel="prefetch" href="/assets/js/33.00bc401b.js"><link rel="prefetch" href="/assets/js/34.276d1ada.js"><link rel="prefetch" href="/assets/js/35.909108a7.js"><link rel="prefetch" href="/assets/js/36.6c085069.js"><link rel="prefetch" href="/assets/js/37.ca67eb20.js"><link rel="prefetch" href="/assets/js/38.8b61f2a2.js"><link rel="prefetch" href="/assets/js/39.fa8755c7.js"><link rel="prefetch" href="/assets/js/4.14931626.js"><link rel="prefetch" href="/assets/js/40.3ea7913e.js"><link rel="prefetch" href="/assets/js/41.0e790312.js"><link rel="prefetch" href="/assets/js/42.efdd8b2b.js"><link rel="prefetch" href="/assets/js/43.7c8cfdf0.js"><link rel="prefetch" href="/assets/js/44.3aa1ef65.js"><link rel="prefetch" href="/assets/js/45.91a09df3.js"><link rel="prefetch" href="/assets/js/46.c81230ba.js"><link rel="prefetch" href="/assets/js/47.e59c6e67.js"><link rel="prefetch" href="/assets/js/48.86971a4c.js"><link rel="prefetch" href="/assets/js/49.8855787d.js"><link rel="prefetch" href="/assets/js/5.387d1024.js"><link rel="prefetch" href="/assets/js/6.ee4d8439.js"><link rel="prefetch" href="/assets/js/7.e8a62932.js"><link rel="prefetch" href="/assets/js/8.87251494.js"><link rel="prefetch" href="/assets/js/9.38301be9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3d89bc54.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">IT Forever Young</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/interview/" class="nav-link router-link-active">
  面试专题
</a></div><div class="nav-item"><a href="https://github.com/itForeverYoung/ItForeverYoung" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  404
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/interview/" class="nav-link router-link-active">
  面试专题
</a></div><div class="nav-item"><a href="https://github.com/itForeverYoung/ItForeverYoung" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  404
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>这里是面试专题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/Java.html" class="sidebar-link">Java</a></li><li><a href="/interview/hashmap.html" class="sidebar-link">HashMap</a></li><li><a href="/interview/concurrent-hashmap.html" class="sidebar-link">ConcurrentHashMap</a></li><li><a href="/interview/thread-pool-executor.html" class="sidebar-link">ThreadPoolExecutor</a></li><li><a href="/interview/ReentrantLock.html" class="sidebar-link">ReentrantLock</a></li><li><a href="/interview/ReadWriteLock.html" class="sidebar-link">ReadWriteLock（读写锁）</a></li><li><a href="/interview/JVM.html" class="sidebar-link">JVM</a></li><li><a href="/interview/Spring.html" class="sidebar-link">Spring</a></li><li><a href="/interview/spring-aop.html" class="sidebar-link">Spring aop</a></li><li><a href="/interview/spring-bean-life-cycle.html" class="sidebar-link">Spring bean 生命周期</a></li><li><a href="/interview/spring-bean-circular-dependency.html" class="sidebar-link">Spring bean 循环依赖</a></li><li><a href="/interview/spring-bean-post-processor.html" class="sidebar-link">Spring bean 后置处理器</a></li><li><a href="/interview/Spring-mvc.html" class="sidebar-link">Spring MVC</a></li><li><a href="/interview/Spring-boot.html" class="sidebar-link">Spring Boot</a></li><li><a href="/interview/spring-boot-initialize.html" class="active sidebar-link">Spring Boot 启动流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/interview/spring-boot-initialize.html#问题" class="sidebar-link">问题</a></li><li class="sidebar-sub-header"><a href="/interview/spring-boot-initialize.html#思考" class="sidebar-link">思考</a></li><li class="sidebar-sub-header"><a href="/interview/spring-boot-initialize.html#源码分析" class="sidebar-link">源码分析</a></li><li class="sidebar-sub-header"><a href="/interview/spring-boot-initialize.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/interview/Spring-cloud.html" class="sidebar-link">Spring Cloud</a></li><li><a href="/interview/Mybatis.html" class="sidebar-link">Mybatis</a></li><li><a href="/interview/MySQL.html" class="sidebar-link">MySQL</a></li><li><a href="/interview/MyCat.html" class="sidebar-link">Mycat</a></li><li><a href="/interview/ShardingSphere.html" class="sidebar-link">ShardingSphere</a></li><li><a href="/interview/Redis.html" class="sidebar-link">Redis</a></li><li><a href="/interview/MQ.html" class="sidebar-link">MQ</a></li><li><a href="/interview/io.html" class="sidebar-link">IO 篇</a></li><li><a href="/interview/tcp-ip.html" class="sidebar-link">计算机网络篇</a></li><li><a href="/interview/MongoDB.html" class="sidebar-link">MongoDB</a></li><li><a href="/interview/ElasticSearch.html" class="sidebar-link">ElasticSearch</a></li><li><a href="/interview/Docker.html" class="sidebar-link">Docker</a></li><li><a href="/interview/设计模式.html" class="sidebar-link">设计模式</a></li><li><a href="/interview/排序算法.html" class="sidebar-link">排序算法</a></li><li><a href="/interview/经典数据结构.html" class="sidebar-link">经典数据结构</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="spring-boot-启动流程"><a href="#spring-boot-启动流程" class="header-anchor">#</a> Spring Boot 启动流程</h1> <p><strong>OK，废话不多说，今天我们来聊一下，spring boot的启动流程。</strong></p> <h2 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h2> <ol><li>spring boot如何初始化spring容器的？</li> <li>spring boot如何启动内嵌的web服务器的？</li></ol> <h2 id="思考"><a href="#思考" class="header-anchor">#</a> 思考</h2> <p><strong>首先，先思考下，一个普通的spring项目是如何变成一个web服务。</strong></p> <ol><li>要有一个spring的web应用。</li> <li>要有一个web应用服务器，比如说Tomcat。</li> <li>将这个spring应用打war包，放入web容器中，执行start.sh脚本，启动web容器。</li></ol> <p><strong>然后，再猜测下，spring boot要怎么做，才能做到一个启动类完成上述3个步骤。</strong></p> <ol><li>标注当前应用是一个web应用。</li> <li>启动spring容器。</li> <li>启动内嵌的web应用服务器，比如说Tomcat。</li></ol> <p><strong>OK，那下面，就带着问题和猜测，去翻一下spring boot的源码，看看它到底是如何启动的。</strong></p> <h2 id="源码分析"><a href="#源码分析" class="header-anchor">#</a> 源码分析</h2> <ol><li><p>首先，在每一个spring boot的启动类中，都可以看到这样一段代码。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">DemoApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div></li> <li><p>点击进入SpringApplication类，可以看到，在这个类中，定义了三个常量，分别对应三种不同的ApplicationContext的实现类，这三个常量，在后面初始化content容器的时候，会使用到。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">/**
	 * The class name of application context that will be used by default for non-web
	 * environments.
	 */</span>
<span class="token comment">// 创建一个普通的Spring应用，使用AnnotationConfigApplicationContext</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DEFAULT_CONTEXT_CLASS <span class="token operator">=</span> <span class="token string">&quot;org.springframework.context.&quot;</span>
			<span class="token operator">+</span> <span class="token string">&quot;annotation.AnnotationConfigApplicationContext&quot;</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * The class name of application context that will be used by default for web
	 * environments.
	 */</span>
<span class="token comment">// 创建一个Spring web应用，使用AnnotationConfigServletWebServerApplicationContext</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DEFAULT_SERVLET_WEB_CONTEXT_CLASS <span class="token operator">=</span> <span class="token string">&quot;org.springframework.boot.&quot;</span>
			<span class="token operator">+</span> <span class="token string">&quot;web.servlet.context.AnnotationConfigServletWebServerApplicationContext&quot;</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * The class name of application context that will be used by default for reactive web
	 * environments.
	 */</span>
<span class="token comment">// 创建一个响应式的Spring web应用，使用AnnotationConfigReactiveWebServerApplicationContext</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DEFAULT_REACTIVE_WEB_CONTEXT_CLASS <span class="token operator">=</span> <span class="token string">&quot;org.springframework.&quot;</span>
			<span class="token operator">+</span> <span class="token string">&quot;boot.web.reactive.context.AnnotationConfigReactiveWebServerApplicationContext&quot;</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>接下来，看一下run()方法，在SpringApplication中，run()方法重载了两次。</p> <div class="language-java extra-class"><pre class="language-java"><code>  
  <span class="token comment">// run()方法第二次重载，这里，也就是给spring boot启动类调用的run()方法，是个空壳方法，把传入的class对象放到了数组中，然后紧接着调用了下方第一次重载的run()方法。</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ConfigurableApplicationContext</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> primarySource<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> primarySource <span class="token punctuation">}</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// run()方法第一次重载，根据传入的class数组，初始化了一个SpringApplication对象。</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ConfigurableApplicationContext</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> primarySources<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span>primarySources<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>接下来，查看SpringApplication的构造方法，先关注两点：</p> <ol><li>primarySources这个集合被初始化了，并且放入了启动类的class对象。</li> <li>webApplicationType这个参数被赋值了。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">// 空壳方法，resourceLoader参数给了null值</span>
	<span class="token keyword">public</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> primarySources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> primarySources<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rawtypes&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span><span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> primarySources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 此时，这里的resourceLoader是空的，记住，下面的启动流程会对它进行初始化</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader <span class="token operator">=</span> resourceLoader<span class="token punctuation">;</span>
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>primarySources<span class="token punctuation">,</span> <span class="token string">&quot;PrimarySources must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1. 将启动类的class对象添加到了primarySources这个set集合中</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>primarySources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>primarySources<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 这里，调用WebApplicationType.deduceFromClasspath()进行判断，当前正在启动的应用是一个什么类型的应用，有三种情况：NONE，SERVLET，REACTIVE</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>webApplicationType <span class="token operator">=</span> <span class="token class-name">WebApplicationType</span><span class="token punctuation">.</span><span class="token function">deduceFromClasspath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 3. 下面三行代码，还没分析，不影响主流程的执行，暂时放个TODO</span>
		<span class="token function">setInitializers</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span> <span class="token function">getSpringFactoriesInstances</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContextInitializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">setListeners</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span> <span class="token function">getSpringFactoriesInstances</span><span class="token punctuation">(</span><span class="token class-name">ApplicationListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>mainApplicationClass <span class="token operator">=</span> <span class="token function">deduceMainApplicationClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>得到SpringApplication的一个对象后，来执行真正的run()方法。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">/**
	 * Run the Spring application, creating and refreshing a new
	 * {@link ApplicationContext}.
	 * @param args the application arguments (usually passed from a Java main method)
	 * @return a running {@link ApplicationContext}
	 */</span>
  <span class="token comment">// 原始run()方法</span>
	<span class="token keyword">public</span> <span class="token class-name">ConfigurableApplicationContext</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">ConfigurableApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpringBootExceptionReporter</span><span class="token punctuation">&gt;</span></span> exceptionReporters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">configureHeadlessProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建一个SpringApplicationRunListeners的对象，对象中有一个集合，存放了一组监听器，在这一步，创建成功后，集合中只有一个监听器：org.springframework.boot.context.event.EventPublishingRunListener</span>
		<span class="token class-name">SpringApplicationRunListeners</span> listeners <span class="token operator">=</span> <span class="token function">getRunListeners</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动集合中的所有监听器</span>
		listeners<span class="token punctuation">.</span><span class="token function">starting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token class-name">ApplicationArguments</span> applicationArguments <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultApplicationArguments</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">ConfigurableEnvironment</span> environment <span class="token operator">=</span> <span class="token function">prepareEnvironment</span><span class="token punctuation">(</span>listeners<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">configureIgnoreBeanInfo</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">Banner</span> printedBanner <span class="token operator">=</span> <span class="token function">printBanner</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 上面的这几行代码，猜测应该是初始化运行环境，没有详细去看，但不影响分析主流程，留个TODO</span>
      <span class="token comment">// 到这里，关键来了，调用createApplicationContext()方法初始化context上下文，先拉到下面先分析下这个方法。</span>
      <span class="token comment">// 分析完成后，可以得知，在这里，context会被赋值，</span>
      <span class="token comment">// 启动的是一个默认web服务器spring boot应用，那context就会成为一个AnnotationConfigServletWebServerApplicationContext对象</span>
			context <span class="token operator">=</span> <span class="token function">createApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 得到一组异常分析的类</span>
			exceptionReporters <span class="token operator">=</span> <span class="token function">getSpringFactoriesInstances</span><span class="token punctuation">(</span><span class="token class-name">SpringBootExceptionReporter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
					<span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 准备context上下文，留个TODO</span>
			<span class="token function">prepareContext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> listeners<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">,</span> printedBanner<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 重中之重！！！关键方法来了，拉到下面，直接分析refreshContext(context)方法</span>
      <span class="token function">refreshContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">afterRefresh</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
			stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logStartupInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">new</span> <span class="token class-name">StartupInfoLogger</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mainApplicationClass<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logStarted</span><span class="token punctuation">(</span><span class="token function">getApplicationLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stopWatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			listeners<span class="token punctuation">.</span><span class="token function">started</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">callRunners</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> applicationArguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">handleRunFailure</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ex<span class="token punctuation">,</span> exceptionReporters<span class="token punctuation">,</span> listeners<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			listeners<span class="token punctuation">.</span><span class="token function">running</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">handleRunFailure</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ex<span class="token punctuation">,</span> exceptionReporters<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> context<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

  <span class="token comment">// 这个方法很简单，一个switch，根据上文提到的webApplicationType去获取一个contextClass对象，获取的对象也是在类头部的三个常量（contextClass的全限定名）</span>
  <span class="token comment">// 到这，就可以回答第一个猜测了，spring boot如何标记当前应用是一个spring web应用？</span>
  <span class="token comment">// 通过判断webApplicationType的值，来获取对应的context上下文</span>
  <span class="token comment">// SERVLET: 创建一个Spring web应用</span>
  <span class="token comment">// REACTIVE: 创建一个响应式的Spring web应用</span>
  <span class="token comment">// NONE: 创建一个普通的Spring应用</span>
  <span class="token keyword">protected</span> <span class="token class-name">ConfigurableApplicationContext</span> <span class="token function">createApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> contextClass <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContextClass<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>contextClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>webApplicationType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">case</span> SERVLET<span class="token operator">:</span>
					contextClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>DEFAULT_SERVLET_WEB_CONTEXT_CLASS<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> REACTIVE<span class="token operator">:</span>
					contextClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>DEFAULT_REACTIVE_WEB_CONTEXT_CLASS<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">default</span><span class="token operator">:</span>
					contextClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>DEFAULT_CONTEXT_CLASS<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
						<span class="token string">&quot;Unable create a default ApplicationContext, please specify an ApplicationContextClass&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">)</span> <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">instantiateClass</span><span class="token punctuation">(</span>contextClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// SpringApplication中的refreshContext方法</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">refreshContext</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用当前类的refresh()方法</span>
		<span class="token function">refresh</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registerShutdownHook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 注册关闭钩子</span>
				context<span class="token punctuation">.</span><span class="token function">registerShutdownHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AccessControlException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// Not allowed in some environments.</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token comment">// 到这里，就能回答的第二个猜测了，spring boot如何启动spring容器的？</span>
<span class="token comment">// 调用AbstractApplicationContext的refresh()方法，来初始化spring容器的。</span>
<span class="token comment">// 这个类是不是有点耳熟，没错，在分析spring的声明周期的时候，就分析过这个类，这个类就是spring容器启动最核心的类之一。</span>
<span class="token comment">// 看下图(1)，我用简单（其实不简单，因为第一次画。-_-）画了一个AbstractApplicationContext这个类的实现和继承树。</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行到这一步，applicationContext必须是AbstractApplicationContext的对象或者其子类对象，否则，会报错</span>
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isInstanceOf</span><span class="token punctuation">(</span><span class="token class-name">AbstractApplicationContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 那这里，实际上就调用了AbstractApplicationContext类的refresh()方法</span>
		<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractApplicationContext</span><span class="token punctuation">)</span> applicationContext<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p><img src="/assets/img/ApplicationContext-structure.40e116ee.jpg" alt="AnnotationConfigServletWebServerApplicationContext"></p> <center>图(1)</center></li> <li><p>从上文，可以得出，在启动一个非响应式的spring boot应用时，spring通过反射的到的applicationContext对象，其实就是AnnotationConfigServletWebServerApplicationContext的实例。</p></li> <li><p>从图中，又可以清晰的看出，AnnotationConfigServletWebServerApplicationContext继承了ServletWebServerApplicationContext，那当spring调用applicationContext的refresh方法时，其实就是调用了ServletWebServerApplicationContext类中的refresh方法，接着看代码。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">// 可以看出，ServletWebServerApplicationContext只是包装了下AbstractApplicationContext的refresh方法，只做了一个catch异常的操作。</span>
  <span class="token comment">// 但是需要注意一点，catch的方法体中，出现了一个词：webServer（这不就是上文猜测中的内嵌的web应用服务器嘛）</span>
  <span class="token comment">// OK，既然这里出现了stop和release，那就肯定有create和start。</span>
  <span class="token comment">// 其实只要看源码就能发现，在refresh()方法下，还有两个方法，分别是onRefresh()和finishRefresh()，其中也分别出现了createWebServer()和startWebServer()，这几个方法我都贴到下文，等下会分析。</span>
  <span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当调用AbstractApplicationContext的refresh方法抛出异常时，需要停止并释放webServer。</span>
			<span class="token function">stopAndReleaseWebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>讲到这，其实基本印证了上文的猜测是大致没错，因为猜测中的三个点，其实都已经出现了。紧接着看下AbstractApplicationContext类的refresh方法，这个方法我在spring bean的生命周期一文已经重点分析过了，所以这里主要看和本文相关的一个关键方法，即方法中调用的onRefresh()方法。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">// 此处，我删除了一些和本文关系不大的代码段</span>
  <span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
		<span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startupShutdownMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
				<span class="token comment">// Initialize other special beans in specific context subclasses.</span>
				<span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
				<span class="token comment">// Last step: publish corresponding event.</span>
				<span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">finally</span> <span class="token punctuation">{</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>onRefresh()是个抽象方法，那执行时肯定是调用其子类实现，根据上面的图(1)可以很清楚的看到，这里会去调用ServletWebServerApplicationContext的onRefresh()方法，这样，也就会调用createWebServer()方法创建web服务器。</p></li> <li><p>同理，由于ServletWebServerApplicationContext重写了AbstractApplicationContext类的finishRefresh()方法，所以，在上面初始化spring容器成功后，会调用ServletWebServerApplicationContext类的finishRefresh()方法，这样，也就会调用startWebServer()方法启动web服务器。</p></li> <li><p>再同理，ServletWebServerApplicationContext也重写了AbstractApplicationContext的onClose()方法，并且，上文提到过，SpringApplication中的refreshContext()方法，在调用了refresh()方法后，还调用了AbstractApplicationContext的registerShutdownHook()方法，注册了一个关闭钩子。所以，当context容器监听到关闭事件时，会先调用子类的onClose()方法，也就调用了stopAndReleaseWebServer()方法关闭web服务器。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">// context容器刷新中调用</span>
  <span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先调用父类的onRefresh()方法</span>
		<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 然后，这里开始创建WebServer。</span>
			<span class="token function">createWebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationContextException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to start web server&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// context容器刷新完成后调用</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先调用父类的finishRefresh()</span>
		<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 然后，启动创建好的webServer</span>
		<span class="token class-name">WebServer</span> webServer <span class="token operator">=</span> <span class="token function">startWebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 最后，发布一个事件到spring容器，通知大家，我这边webServer已经启动了</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>webServer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServletWebServerInitializedEvent</span><span class="token punctuation">(</span>webServer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// context容器关闭时调用，</span>
  <span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先调用父类的onClose()方法，完成context容器关闭需要做的事情</span>
		<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 当容器监听到关闭事件时，也需要关闭并释放webServer</span>
		<span class="token function">stopAndReleaseWebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>OK，到这里，基本上证实了一开始的三个猜测，但是，这里又延伸出一个问题：</p> <p>spring boot是如何把spring context容器放到web服务器中的？</p> <p>你品，你细品，上面全文，其实讲的都是spring context容器的初始化，虽然也有web服务器的create、start、stop，但是，spring context容器和web服务器是如何关联上的呢？</p></li> <li><p>下面，就来看下web服务器是如何创建和启动的，先放一张图(2)，简单看一下。</p> <p><img src="/assets/img/Spring-Boot-WebServer.2b49189f.jpg" alt="Spring-Boot-WebServer"></p> <center>图(2)</center></li> <li><p>从上图中，可以看到，spring boot定义了一个WebServer的接口，并且提供了几种实现，像TomcatWebServer、JettyWebServer等。</p></li> <li><p>以Spring boot默认的内嵌服务器Tomcat为例，分析下源码。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">// 这就是上文说的和webServer相关的三个方法</span>
  <span class="token comment">// create</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createWebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">WebServer</span> webServer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>webServer<span class="token punctuation">;</span>
		<span class="token class-name">ServletContext</span> servletContext <span class="token operator">=</span> <span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 应用初始化的时候，webServer和servletContext都是null，所以此处会通过getWebServerFactory()方法获取当前spring context容器支持的web服务器的工厂类</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>webServer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> servletContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 由于我使用的是Tomcat，所以在这里，会得到一个TomcatServletWebServerFactory的实例对象。</span>
			<span class="token class-name">ServletWebServerFactory</span> factory <span class="token operator">=</span> <span class="token function">getWebServerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 这里也是工厂方法的典型应用，然后，通过factory.getWebServer(getSelfInitializer())，就能的到一个webServer对象，到这里，web服务器就有了。</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>webServer <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">getWebServer</span><span class="token punctuation">(</span><span class="token function">getSelfInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>servletContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
				<span class="token function">getSelfInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onStartup</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ServletException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationContextException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot initialize servlet context&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token function">initPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// start</span>
  <span class="token keyword">private</span> <span class="token class-name">WebServer</span> <span class="token function">startWebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">WebServer</span> webServer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>webServer<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>webServer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 启动web服务器</span>
			webServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> webServer<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// stop and release</span>
	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">stopAndReleaseWebServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">WebServer</span> webServer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>webServer<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>webServer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 停止web服务器</span>
				webServer<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>webServer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>上文提到，getWebServerFactory()方法会得到一个WebServerFactory的实例，然后，再调用工厂类的getWebServer(getSelfInitializer())方法来得到一个WebServer的实例，那接下来以TomcatServletWebServerFactory为例，分析下，spring boot是如何创建一个Tomcat的web容器的。</p> <p><strong>注：首先说明下，因为Tomcat的启动内容也很多，而本文又只是为了分析spring boot的启动流程，那么，下面最应该关心的是，spring context和Tomcat context是如何关联上的。所以，接下来的分析会快一点，和Tomcat相关的内容，会在之后Tomcat篇专门说明。</strong></p></li> <li><p>在这里，先简单描述下Tomcat各个组件之间的关系，详细见下图(3)。</p> <p><img src="/assets/img/Tomcat-Components.3f7f9796.jpg" alt="Tomcat组件图"></p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">// </span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">WebServer</span> <span class="token function">getWebServer</span><span class="token punctuation">(</span><span class="token class-name">ServletContextInitializer</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> initializers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里的initializers，其实就是spring容器的上下文，也就是上文创建的AnnotationConfigServletWebServerApplicationContext的实例，所以，接下来的分析，主要跟踪这个对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>disableMBeanRegistry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Registry</span><span class="token punctuation">.</span><span class="token function">disableRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 首先，new一个Tomcat的对象，这个类是在Tomcat的包下</span>
    <span class="token class-name">Tomcat</span> tomcat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tomcat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 得到默认的文件路径，如果没有，就创建一个临时的tomcat路径</span>
    <span class="token class-name">File</span> baseDir <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>baseDirectory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseDirectory <span class="token operator">:</span> <span class="token function">createTempDir</span><span class="token punctuation">(</span><span class="token string">&quot;tomcat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tomcat<span class="token punctuation">.</span><span class="token function">setBaseDir</span><span class="token punctuation">(</span>baseDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取默认的连接器，protocol默认是Http11NioProtocol</span>
    <span class="token class-name">Connector</span> connector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Connector</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动失败时抛出异常</span>
    connector<span class="token punctuation">.</span><span class="token function">setThrowOnFailure</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 给默认的service添加连接器</span>
    tomcat<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addConnector</span><span class="token punctuation">(</span>connector<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">customizeConnector</span><span class="token punctuation">(</span>connector<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tomcat<span class="token punctuation">.</span><span class="token function">setConnector</span><span class="token punctuation">(</span>connector<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置非自动部署</span>
    tomcat<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoDeploy</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 配置容器中的engines组件</span>
    <span class="token function">configureEngine</span><span class="token punctuation">(</span>tomcat<span class="token punctuation">.</span><span class="token function">getEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Connector</span> additionalConnector <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>additionalTomcatConnectors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tomcat<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addConnector</span><span class="token punctuation">(</span>additionalConnector<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 由于最终是要讲spring context放到tomcat context中，所以这里传入tomcat的host组件，进行进一步组装</span>
    <span class="token function">prepareContext</span><span class="token punctuation">(</span>tomcat<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> initializers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">getTomcatWebServer</span><span class="token punctuation">(</span>tomcat<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">prepareContext</span><span class="token punctuation">(</span><span class="token class-name">Host</span> host<span class="token punctuation">,</span> <span class="token class-name">ServletContextInitializer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> initializers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取当前spring boot应用的的根目录</span>
    <span class="token class-name">File</span> documentRoot <span class="token operator">=</span> <span class="token function">getValidDocumentRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这里new了一个TomcatEmbeddedContext的对象，TomcatEmbeddedContext继承了StandardContext，而StandardContext也就是tomcat中的context组件的默认实现</span>
    <span class="token class-name">TomcatEmbeddedContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TomcatEmbeddedContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>documentRoot <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      context<span class="token punctuation">.</span><span class="token function">setResources</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoaderHidingResourceRoot</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    context<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">setDisplayName</span><span class="token punctuation">(</span><span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">File</span> docBase <span class="token operator">=</span> <span class="token punctuation">(</span>documentRoot <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> documentRoot <span class="token operator">:</span> <span class="token function">createTempDir</span><span class="token punctuation">(</span><span class="token string">&quot;tomcat-docbase&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">setDocBase</span><span class="token punctuation">(</span>docBase<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 给context组件设置生命周期监听类</span>
    context<span class="token punctuation">.</span><span class="token function">addLifecycleListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FixContextListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置context的父类加载器，也就是jdk默认的应用加载器AppClassLoader</span>
    context<span class="token punctuation">.</span><span class="token function">setParentClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getDefaultClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这里省略了一下context组件的初始化代码</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
    <span class="token class-name">ServletContextInitializer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> initializersToUse <span class="token operator">=</span> <span class="token function">mergeInitializers</span><span class="token punctuation">(</span>initializers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将context设置到host组件中</span>
    host<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//</span>
    <span class="token function">configureContext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> initializersToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">postProcessContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configureContext</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ServletContextInitializer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> initializers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里启动了一个TomcatStarter，将spring context注入进去</span>
		<span class="token class-name">TomcatStarter</span> starter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TomcatStarter</span><span class="token punctuation">(</span>initializers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果当前的context是TomcatEmbeddedContext实例，直接setStarter，如果不是，则将starter添加到context的initializers的集合中</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token keyword">instanceof</span> <span class="token class-name">TomcatEmbeddedContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">TomcatEmbeddedContext</span> embeddedContext <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TomcatEmbeddedContext</span><span class="token punctuation">)</span> context<span class="token punctuation">;</span>
			embeddedContext<span class="token punctuation">.</span><span class="token function">setStarter</span><span class="token punctuation">(</span>starter<span class="token punctuation">)</span><span class="token punctuation">;</span>
			embeddedContext<span class="token punctuation">.</span><span class="token function">setFailCtxIfServletStartFails</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		context<span class="token punctuation">.</span><span class="token function">addServletContainerInitializer</span><span class="token punctuation">(</span>starter<span class="token punctuation">,</span> NO_CLASSES<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 这里省略了一下无关代码</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 再回到上文，当Tomcat初始化完成后，调用getTomcatWebServer()方法得到一个TomcatWebServer，其实这里也就是将Tomcat实例包装一下，包装成spring boot应用定义的webServer实现，以此通过spring控制tomcat的声明周期。</span>
  <span class="token keyword">protected</span> <span class="token class-name">TomcatWebServer</span> <span class="token function">getTomcatWebServer</span><span class="token punctuation">(</span><span class="token class-name">Tomcat</span> tomcat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TomcatWebServer</span><span class="token punctuation">(</span>tomcat<span class="token punctuation">,</span> <span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">// 接下来简单看下TomcatWebServer的初始化</span>
  <span class="token keyword">public</span> <span class="token class-name">TomcatWebServer</span><span class="token punctuation">(</span><span class="token class-name">Tomcat</span> tomcat<span class="token punctuation">,</span> <span class="token keyword">boolean</span> autoStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>tomcat<span class="token punctuation">,</span> <span class="token string">&quot;Tomcat Server must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tomcat <span class="token operator">=</span> tomcat<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>autoStart <span class="token operator">=</span> autoStart<span class="token punctuation">;</span>
    <span class="token comment">// 调用initialize()方法</span>
    <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">WebServerException</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Tomcat initialized with port(s): &quot;</span> <span class="token operator">+</span> <span class="token function">getPortsDescription</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>monitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置engines名称</span>
        <span class="token function">addInstanceIdToEngineName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取当前的tomcat context</span>
        <span class="token class-name">Context</span> context <span class="token operator">=</span> <span class="token function">findContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">addLifecycleListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Lifecycle</span><span class="token punctuation">.</span>START_EVENT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Remove service connectors so that protocol binding doesn't</span>
            <span class="token comment">// happen when the service is started.</span>
            <span class="token function">removeServiceConnectors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Start the server to trigger initialization listeners</span>
        <span class="token comment">// 启动webServer中的tomcat容器，来触发各种监听事件</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// 这里省略了一些代码</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">// Unlike Jetty, all Tomcat threads are daemon threads. We create a</span>
        <span class="token comment">// blocking non-daemon to stop immediate shutdown</span>
        <span class="token comment">// 启动一个后台线程，使tomcat运行起来，并且不关闭，内部其实就是调用了其tomcat变量的await()方法</span>
        <span class="token function">startDaemonAwaitThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">stopSilently</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">destroySilently</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WebServerException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to start embedded Tomcat&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 启动一个后台线程，让tomcat运行起来</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startDaemonAwaitThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Thread</span> awaitThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token string">&quot;container-&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>containerCounter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

			<span class="token annotation punctuation">@Override</span>
			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 其实就是调用了StandardServer的await()方法</span>
				<span class="token class-name">TomcatWebServer</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span><span class="token function">getServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

		<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置等待线程的上下文类加载器</span>
		awaitThread<span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 非守护线程运行</span>
		awaitThread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动这个线程</span>
		awaitThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>到这里，spring boot的启动流程就基本串起来了。</p></li> <li><p>那么，最后，再看下通过idea生成的TomcatServletWebServerFactory的类图，其实就单论WebServerFactory类的实现这一块，就很复杂，Spring boot为了支持多种内嵌web服务器，也是很好地遵守了对扩展开放，对修改关闭的设计原则，以后有时间，也可以专门写一篇文章分析下这块。</p> <p><img src="/assets/img/TomcatServletWebServerFactory.7f674171.png" alt="TomcatServletWebServerFactory"></p></li></ol> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>本文主要分析了spring boot应用的启动流程，但是呢，只解释了主线，一些支线并没有描述。</p> <ol><li>比如说内嵌的WebServer如何初始化的，</li> <li>如何通过WebServerFactory的到一个具体的WebServer实例，</li> <li>spring boot封装的TomcatWebServer和Tomcat又有什么关系，</li> <li>还有例子中的Tomcat的容器中各个组件是如何启动的，分别作了什么动作等等。</li></ol> <p>为什么没讲呢？</p> <ol><li>一是因为每一个点扩展出去都可以写一篇文章，</li> <li>二是因为这些和本文的主题关系没那么大，</li> <li>最重要的一点是因为我也没有研究明白（-_-），所以为了避免模棱两可，但凡我没理解的，都做了省略，没有分析。</li></ol> <p>那么最后就以一张图来总结下spring boot的启动流程吧。</p> <p><img src="/assets/img/spring-boot-initialized.3c820e53.jpg" alt="Spring boot 启动流程"></p> <p>OK，那本期面试题解答就到这里了，欢迎各位大佬多提宝贵意见，我们下期再见。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/interview/Spring-boot.html" class="prev">
        Spring Boot
      </a></span> <span class="next"><a href="/interview/Spring-cloud.html">
        Spring Cloud
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8adec5b5.js" defer></script><script src="/assets/js/2.2552ee46.js" defer></script><script src="/assets/js/3.b0bf1cd6.js" defer></script>
  </body>
</html>
